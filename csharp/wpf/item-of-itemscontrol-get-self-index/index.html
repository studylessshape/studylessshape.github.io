<!doctype html><html lang=zh><meta charset=utf-8><meta name=generator content="Hugo 0.119.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><title>ItemsControl 组件的 Item 获取自己的 Index&nbsp;&ndash;&nbsp;学少何Blog</title><link rel=stylesheet href=/css/core.min.32478a57f52c16ea8d985cfbd2d28edda6d39bfc82a9b118b94caa532c16ce3f1e869e1d49ccce4a74134efed6bdafa0.css integrity=sha384-MkeKV/UsFuqNmFz70tKO3abTm/yCqbEYuUyqUywWzj8ehp4dSczOSnQTTv7Wva+g><meta name=twitter:card content="summary"><meta name=twitter:title content="ItemsControl 组件的 Item 获取自己的 Index"><body><section id=header><div class="header wrap"><span class="header left-side"><a class="site home" href=/><span class="site name">学少何Blog</span></a></span>
<span class="header right-side"><div class="nav wrap"><nav class=nav><a class="nav item" href=/categories>归类</a><a class="nav item" href=/tags>标签</a><a class="nav item" href=/about>关于</a><a class="nav item" href=/index%2exml>RSS</a></nav></div></span></div></section><section id=content><div class=article-container><section class="article header"><h1 class="article title">ItemsControl 组件的 Item 获取自己的 Index</h1><p class="article date">2024年2月23日 2:23</p></section><article class="article markdown-body"><h2 id=目的>目的</h2><p>该功能的目的是为了获取 Item 自身的 Index，并可以绑定到数据模板中。</p><h2 id=创建项目>创建项目</h2><p>创建一个 WPF 应用程序项目，并添加下面的依赖</p><ul><li><a href=https://github.com/MaterialDesignInXAML/MaterialDesignInXamlToolkit target=_blank rel="noopener noreferrer">MaterialDesignThemes</a><blockquote><p>注意按照 <a href=https://github.com/MaterialDesignInXAML/MaterialDesignInXamlToolkit/wiki/Getting-Started target=_blank rel="noopener noreferrer">Getting Start</a> 来配置主题</p></blockquote></li></ul><h2 id=添加-itemscontrol>添加 ItemsControl</h2><p>将 <code>Grid</code> 分为两列，左列添加一个 <code>ItemsControl</code>，并将 <code>ItemsControl.ItemsPanel</code> 中 <code>ItemsPanelTemplate</code> 的内容设置为 <code>WarpPanel</code>，这样，子元素就能够自己排列了。同时将 <code>ItemsControl.ItemTemplate</code> 的模板设置为 <code>DataTemplate</code>。</p><p>现在的代码应该和下面一样，设计器中应该可以看见 <code>Grid</code> 已经被分成两列了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;Grid&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Grid.ColumnDefinitions&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;ColumnDefinition/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;ColumnDefinition/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/Grid.ColumnDefinitions&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;ItemsControl&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;ItemsControl.ItemsPanel&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;ItemsPanelTemplate&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;WrapPanel/&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;/ItemsPanelTemplate&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/ItemsControl.ItemsPanel&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;ItemsControl.ItemTemplate&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;DataTemplate&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;/DataTemplate&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/ItemsControl.ItemTemplate&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/ItemsControl&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/Grid&gt;</span>
</span></span></code></pre></div><p>这个 <code>ItemsControl</code> 所需要做的功能，除了显示每个 Item 自身的 Index，我还希望能够选中并显示到第二列中。</p><p>在 <a href=https://github.com/MaterialDesignInXAML/MaterialDesignInXamlToolkit target=_blank rel="noopener noreferrer">MaterialDesignThemes</a> 的 <a href=https://github.com/MaterialDesignInXAML/MaterialDesignInXamlToolkit/releases/tag/v4.9.0 target=_blank rel="noopener noreferrer">DemoApp</a> 中，目录中有一栏叫 Chips，用来做为子控件感觉还不错，复制 Filter Chips 中的代码，添加到 <code>DataTemplate</code> 中。</p><p>把复制过来的代码中的 Content 删除，并将 <code>TextBlock</code> 填入 Content 中，Text 的内容暂时保留。代码应该如下所示：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;ItemsControl&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;ItemsControl.ItemsPanel&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;ItemsPanelTemplate&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;WrapPanel</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/ItemsPanelTemplate&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/ItemsControl.ItemsPanel&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;ItemsControl.ItemTemplate&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;DataTemplate&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;CheckBox</span> <span class=na>IsChecked=</span><span class=s>&#34;True&#34;</span>
</span></span><span class=line><span class=cl>                      <span class=na>Style=</span><span class=s>&#34;{StaticResource MaterialDesignFilterChipPrimaryOutlineCheckBox}&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;TextBlock</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;/CheckBox&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/DataTemplate&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/ItemsControl.ItemTemplate&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/ItemsControl&gt;</span>
</span></span></code></pre></div><p>现在还没有东西显示出来，为了能够显示一点东西，先为 <code>ItemsControl</code> 添加一个硬编码的 ItemSource。</p><p>为了添加的内容较为简单，直接用数组即可，元素则使用字符串。为了使用基本类型，首先需要将 <code>System</code> 命名空间添加到 XAML 当中，此处将其引入名称指定为 <code>sys</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;Window</span> <span class=na>x:Class=</span><span class=s>&#34;IndexWithItemsControl.MainWindow&#34;</span>
</span></span><span class=line><span class=cl>        <span class=err>[...]</span>
</span></span><span class=line><span class=cl>        <span class=na>xmlns:sys=</span><span class=s>&#34;clr-namespace:System;assembly=mscorlib&#34;</span>
</span></span><span class=line><span class=cl>        <span class=err>[...]</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Grid</span><span class=err>[...]</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/Window&gt;</span>
</span></span></code></pre></div><p>接下来为 <code>ItemsControl</code> 添加硬编码的 ItemSource。数组使用 <code>x:Array</code> 标记，字符串我们使用 <code>sys:String</code> 标记。</p><p>随便添加一点元素就行。我的代码如下，简单的添加了三个 <code>String</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;ItemsControl&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;ItemsControl.ItemsSource&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;x:Array</span> <span class=na>Type=</span><span class=s>&#34;{x:Type sys:String}&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;sys:String&gt;</span>a<span class=nt>&lt;/sys:String&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;sys:String&gt;</span>b<span class=nt>&lt;/sys:String&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;sys:String&gt;</span>c<span class=nt>&lt;/sys:String&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/x:Array&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/ItemsControl.ItemsSource&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;ItemsControl.ItemsPanel</span><span class=err>[...]</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;ItemsControl.ItemTemplate</span><span class=err>[...]</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/ItemsControl&gt;</span>
</span></span></code></pre></div><p>这时候已经能看到设计器上面有三个 Chips 按钮了。</p><p><img src=add-itemscontrol.png alt></p><h2 id=添加-converter-来获取-index>添加 Converter 来获取 Index</h2><p>为了获取 Index，我们需要找一下 <code>ItemsControl</code> 的<a href="https://learn.microsoft.com/zh-cn/dotnet/api/system.windows.controls.itemscontrol?view=windowsdesktop-8.0" target=_blank rel="noopener noreferrer">文档</a>，但是里面好像并没有想要的东西。</p><p>不过有一个属性比较令人在意，叫 <a href="https://learn.microsoft.com/zh-cn/dotnet/api/system.windows.controls.itemscontrol.itemcontainergenerator?view=windowsdesktop-8.0" target=_blank rel="noopener noreferrer">ItemContainerGenerator</a>。</p><p>点开这个属性的类型 <a href="https://learn.microsoft.com/zh-cn/dotnet/api/system.windows.controls.itemcontainergenerator?view=windowsdesktop-8.0" target=_blank rel="noopener noreferrer">ItemContainerGenerator 类</a>看看，发现里面有一个函数叫做 <a href="https://learn.microsoft.com/zh-cn/dotnet/api/system.windows.controls.itemcontainergenerator.indexfromcontainer?view=windowsdesktop-8.0#system-windows-controls-itemcontainergenerator-indexfromcontainer%28system-windows-dependencyobject%29" target=_blank rel="noopener noreferrer">IndexFromContainer</a>。</p><p>稍微理一下，首先是 <code>ItemsControl</code> 中有一个 <code>ItemContainerGenerator</code>，每当 <code>ItemsControl</code> 的 ItemSource 更新时，应该会通过这个 Generator 来生成 UI。</p><p>那么现在通过 <code>IndexFromContainer</code> 这个函数，我们应该就可以拿到 Item 对应控件的 Index 了，这个 Index 同样也是 Item 的 Index。但是有一个问题是，这个传入的参数，即当前 Item 对应控件，该如何获取？</p><p>回到 Visual Studio 的项目。我们为 <code>TextBlock</code> 加一个绑定，但是特殊的是这个绑定只写一个语法，并不指定其他的东西，甚至是 <code>Path</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;ItemsControl.ItemTemplate&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;DataTemplate&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;CheckBox</span> <span class=na>IsChecked=</span><span class=s>&#34;True&#34;</span>
</span></span><span class=line><span class=cl>                  <span class=na>Style=</span><span class=s>&#34;{StaticResource MaterialDesignFilterChipPrimaryOutlineCheckBox}&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;TextBlock</span> <span class=na>Text=</span><span class=s>&#34;{Binding}&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/CheckBox&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/DataTemplate&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/ItemsControl.ItemTemplate&gt;</span>
</span></span></code></pre></div><p>看向设计器，一个令人兴奋的效果出现了，我们数组中的元素出现在了 Text 中。</p><p><img src=binding-show-textblock.png alt></p><p>有这么个想法产生了，如果我们获取 <code>DataTemplate</code> 或者 <code>CheckBox</code> 控件，但是不指定其 Path 来绑定，那么传入的不就是控件自身了吗？</p><p>为了调用 <code>IndexFromContainer</code> 函数，还需要获得 <code>ItemsControl</code> 的 <code>ItemContainerGenerator</code>。所以需要用到 <code>MultiBinding</code>，这个绑定和 <code>Binding</code> 的区别在于，它可以绑定多个数据。</p><p>那么事不宜迟，开始为 <code>TextBlock</code> 来进行 <code>MultiBinding</code>。其中的 <code>Binding</code>，分别绑定 <code>ItemsControl</code> 的 <code>ItemContainerGenerator</code> 和当前控件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;TextBlock&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;TextBlock.Text&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;MultiBinding&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;Binding</span> <span class=na>RelativeSource=</span><span class=s>&#34;{RelativeSource Mode=FindAncestor,AncestorType=ItemsControl}&#34;</span><span class=nt>&gt;&lt;/Binding&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;Binding</span> <span class=na>RelativeSource=</span><span class=s>&#34;{RelativeSource Mode=FindAncestor,AncestorType=CheckBox}&#34;</span><span class=nt>&gt;&lt;/Binding&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/MultiBinding&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/TextBlock.Text&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/TextBlock&gt;</span>
</span></span></code></pre></div><p>不过绑定失败了，提示我们需要一个 MultiConverter，而且我们发现我们虽然拿到了控件，但是并不能运行需要的函数。</p><p>为了先使绑定成功，先新建一个 Converter，类的名字命名为 <code>IndexOfItemsControlConverter</code>。类的内容应如下所示。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=k>using</span> <span class=nn>System</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Globalization</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=nn>System.Windows.Data</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>namespace</span> <span class=nn>IndexWithItemsControl.Converters</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=k>class</span> <span class=nc>IndexOfItemsControlConverter</span> <span class=p>:</span> <span class=n>IMultiValueConverter</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>object</span> <span class=n>Convert</span><span class=p>(</span><span class=kt>object</span><span class=p>[]</span> <span class=n>values</span><span class=p>,</span> <span class=n>Type</span> <span class=n>targetType</span><span class=p>,</span> <span class=kt>object</span> <span class=n>parameter</span><span class=p>,</span> <span class=n>CultureInfo</span> <span class=n>culture</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>NotImplementedException</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kd>public</span> <span class=kt>object</span><span class=p>[]</span> <span class=n>ConvertBack</span><span class=p>(</span><span class=kt>object</span> <span class=k>value</span><span class=p>,</span> <span class=n>Type</span><span class=p>[]</span> <span class=n>targetTypes</span><span class=p>,</span> <span class=kt>object</span> <span class=n>parameter</span><span class=p>,</span> <span class=n>CultureInfo</span> <span class=n>culture</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>NotImplementedException</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>为 Converter 实现了 <code>IMultiValueConverter</code> 接口，这样就可以让 <code>MultiBinding</code> 使用此 Converter。</p><blockquote><p>Converter 的使用可以查看 <a href="https://learn.microsoft.com/zh-cn/dotnet/desktop/wpf/data/how-to-convert-bound-data?view=netframeworkdesktop-4.8" target=_blank rel="noopener noreferrer">如何：转换绑定的数据</a></p></blockquote><p>我们可以将返回值直接返回 <code>values</code>，并在 <code>Convert</code> 函数的 return 处打上断点。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=kd>public</span> <span class=kt>object</span> <span class=n>Convert</span><span class=p>(</span><span class=kt>object</span><span class=p>[]</span> <span class=n>values</span><span class=p>,</span> <span class=n>Type</span> <span class=n>targetType</span><span class=p>,</span> <span class=kt>object</span> <span class=n>parameter</span><span class=p>,</span> <span class=n>CultureInfo</span> <span class=n>culture</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>values</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kt>object</span><span class=p>[]</span> <span class=n>ConvertBack</span><span class=p>(</span><span class=kt>object</span> <span class=k>value</span><span class=p>,</span> <span class=n>Type</span><span class=p>[]</span> <span class=n>targetTypes</span><span class=p>,</span> <span class=kt>object</span> <span class=n>parameter</span><span class=p>,</span> <span class=n>CultureInfo</span> <span class=n>culture</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=k>value</span> <span class=k>is</span> <span class=kt>object</span><span class=p>[]</span> <span class=n>list</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>list</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=k>new</span> <span class=kt>object</span><span class=p>[]</span> <span class=p>{</span> <span class=k>value</span> <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>然后将该 Converter 应用到刚才 <code>TextBlock.Text</code> 的绑定中。需要首先引入命名空间，然后将 Converter 添加到资源当中，并设置它的 Key。最后添加到绑定中。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;Window</span> <span class=err>[...]</span>
</span></span><span class=line><span class=cl>        <span class=na>xmlns:converter=</span><span class=s>&#34;clr-namespace:IndexWithItemsControl.Converters&#34;</span>
</span></span><span class=line><span class=cl>        <span class=err>[...]</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Window.Resources&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;converter:IndexOfItemsControlConverter</span> <span class=na>x:Key=</span><span class=s>&#34;IndexOfItemsControlConverter&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/Window.Resources&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Grid&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;Grid.ColumnDefinitions</span><span class=err>[...]</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;ItemsControl&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;ItemsControl.ItemsSource</span><span class=err>[...]</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;ItemsControl.ItemsPanel</span><span class=err>[...]</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;ItemsControl.ItemTemplate&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;DataTemplate&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&lt;CheckBox</span><span class=err>[...]</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&lt;TextBlock&gt;</span>
</span></span><span class=line><span class=cl>                            <span class=nt>&lt;TextBlock.Text&gt;</span>
</span></span><span class=line><span class=cl>                                <span class=nt>&lt;MultiBinding</span> <span class=na>Converter=</span><span class=s>&#34;{StaticResource IndexOfItemsControlConverter}&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>                                    <span class=nt>&lt;Binding</span><span class=err>[...]</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>                                    <span class=nt>&lt;Binding</span><span class=err>[...]</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>                                <span class=nt>&lt;/MultiBinding&gt;</span>
</span></span><span class=line><span class=cl>                            <span class=nt>&lt;/TextBlock.Text&gt;</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&lt;/TextBlock&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&lt;/CheckBox&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;/DataTemplate&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;/ItemsControl.ItemTemplate&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/ItemsControl&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/Grid&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/Window&gt;</span>
</span></span></code></pre></div><p>现在调试运行一下，看绑定的控件是否都传入了。</p><p><img src=convert-values.png alt></p><p>如果和上图一样，都是这 <code>ItemsControl</code> 和 <code>CheckBox</code> 类型，那么说明绑定成功了。如果调试步骤没有进入 Convert，或者 <code>values</code> 的内容有区别，需要检查一下绑定是否是按照上面的来的。</p><blockquote><p>你可能注意到了有几个绑定失败的提示，这是因为在 Convert 中返回的 <code>values</code> 在退出函数之后被销毁了，所以 <code>TextBlock.Text</code> 拿到了一个空值。</p><p>如果需要拿到非空值，需要使用 <code>values.Clone()</code>。</p></blockquote><p>现在需要的内容都有了，开始获取 Index 吧！</p><p>在 Convert 函数中，先把 <code>ItemsControl</code> 和 <code>CheckBox</code> 选出来。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=kd>public</span> <span class=kt>object</span> <span class=n>Convert</span><span class=p>(</span><span class=kt>object</span><span class=p>[]</span> <span class=n>values</span><span class=p>,</span> <span class=n>Type</span> <span class=n>targetType</span><span class=p>,</span> <span class=kt>object</span> <span class=n>parameter</span><span class=p>,</span> <span class=n>CultureInfo</span> <span class=n>culture</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ItemsControl</span><span class=p>?</span> <span class=n>itemsControl</span> <span class=p>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>CheckBox</span><span class=p>?</span> <span class=n>checkBox</span> <span class=p>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>foreach</span> <span class=p>(</span><span class=kt>var</span> <span class=n>val</span> <span class=k>in</span> <span class=n>values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>val</span> <span class=k>is</span> <span class=n>ItemsControl</span> <span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>itemsControl</span> <span class=p>=</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>val</span> <span class=k>is</span> <span class=n>CheckBox</span> <span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>checkBox</span> <span class=p>=</span> <span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>然后，调用方法来获取 Index。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=kd>public</span> <span class=kt>object</span> <span class=n>Convert</span><span class=p>(</span><span class=kt>object</span><span class=p>[]</span> <span class=n>values</span><span class=p>,</span> <span class=n>Type</span> <span class=n>targetType</span><span class=p>,</span> <span class=kt>object</span> <span class=n>parameter</span><span class=p>,</span> <span class=n>CultureInfo</span> <span class=n>culture</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// ...</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>itemsControl</span> <span class=p>!=</span> <span class=kc>null</span> <span class=p>&amp;&amp;</span> <span class=n>checkBox</span> <span class=p>!=</span> <span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>index</span> <span class=p>=</span> <span class=n>itemsControl</span><span class=p>.</span><span class=n>ItemContainerGenerator</span><span class=p>.</span><span class=n>IndexFromContainer</span><span class=p>(</span><span class=n>checkBox</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>index</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>生成一下项目，回到设计器，会发现 Text 还是没有内容。</p><p>在 <code>var index = ...</code> 处打上断点，然后调试执行。看向 <code>Index</code>，会发现其值为 -1。</p><p><img src=convert-error-index.png alt></p><p>这显然不符合我们的需求，<code>IndexFromContainer</code> 并没有找到我们需要的 Index，同时取消断点，会发现绑定又失败了，绑定的值又变为了 <code>null</code>。</p><p>看向官方文档 <a href="https://learn.microsoft.com/zh-cn/dotnet/api/system.windows.data.relativesourcemode?view=windowsdesktop-8.0#fields" target=_blank rel="noopener noreferrer">RelativeSourceMode Enum</a>，有一项叫做 <code>TemplatedParent</code>。翻译看看描述。</p><p><img src=mode-templated-parent.png alt></p><p>大概意思是能够获取到绑定的模板控件，那么将绑定的内容修改一下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;MultiBinding</span><span class=err>[...]</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Binding</span><span class=err>[...]</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Binding</span> <span class=na>RelativeSource=</span><span class=s>&#34;{RelativeSource Mode=TemplatedParent}&#34;</span><span class=nt>&gt;&lt;/Binding&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/MultiBinding&gt;</span>
</span></span></code></pre></div><p>同时在 Convert 方法中打一下断点，看看其内容。</p><p><img src=templated-parent-type.png alt></p><p>发现它的类型是 <code>ContentPresenter</code>。修改 Convert 函数的内容。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=kd>public</span> <span class=kt>object</span> <span class=n>Convert</span><span class=p>(</span><span class=kt>object</span><span class=p>[]</span> <span class=n>values</span><span class=p>,</span> <span class=n>Type</span> <span class=n>targetType</span><span class=p>,</span> <span class=kt>object</span> <span class=n>parameter</span><span class=p>,</span> <span class=n>CultureInfo</span> <span class=n>culture</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ItemsControl</span><span class=p>?</span> <span class=n>itemsControl</span> <span class=p>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=c1>// modify</span>
</span></span><span class=line><span class=cl>    <span class=n>ContentPresenter</span><span class=p>?</span> <span class=n>content</span> <span class=p>=</span> <span class=kc>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>foreach</span> <span class=p>(</span><span class=kt>var</span> <span class=n>val</span> <span class=k>in</span> <span class=n>values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>val</span> <span class=k>is</span> <span class=n>ItemsControl</span> <span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>itemsControl</span> <span class=p>=</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>//         modify</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>val</span> <span class=k>is</span> <span class=n>ContentPresenter</span> <span class=n>c</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=p>=</span> <span class=n>c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>//                          modify</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>itemsControl</span> <span class=p>!=</span> <span class=kc>null</span> <span class=p>&amp;&amp;</span> <span class=n>content</span> <span class=p>!=</span> <span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>//                                                                 modify</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>index</span> <span class=p>=</span> <span class=n>itemsControl</span><span class=p>.</span><span class=n>ItemContainerGenerator</span><span class=p>.</span><span class=n>IndexFromContainer</span><span class=p>(</span><span class=n>content</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s>$&#34;{index}&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=s>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>再次生成项目，回到设计器，应该可以看到 Text 的内容变成 Index 了。</p><p><img src=item-index-in-view.png alt></p><p>当然可以返回时 <code>+1</code>，即 <code>return $"{index + 1}";</code> ，这样显示的起始 Index 就是 1 了。</p><p><img src=after-index-add-one.png alt></p><h2 id=附>附</h2><p>仓库链接：<a href=https://github.com/studylessshape/WPFUserRecord/tree/main/IndexWithItemsControl target=_blank rel="noopener noreferrer">IndexWithItemsControl</a></p><p>文档列表：</p><ul><li><a href=https://github.com/MaterialDesignInXAML/MaterialDesignInXamlToolkit/wiki/Getting-Started target=_blank rel="noopener noreferrer">MaterialDesignThemes - Getting Start</a></li><li><a href="%28https://learn.microsoft.com/zh-cn/dotnet/api/system.windows.controls.itemscontrol?view=windowsdesktop-8.0%29">ItemsControl</a></li><li><a href="https://learn.microsoft.com/zh-cn/dotnet/api/system.windows.controls.itemcontainergenerator?view=windowsdesktop-8.0" target=_blank rel="noopener noreferrer">ItemContainerGenerator 类</a></li><li><a href="https://learn.microsoft.com/zh-cn/dotnet/desktop/wpf/data/how-to-convert-bound-data?view=netframeworkdesktop-4.8" target=_blank rel="noopener noreferrer">如何：转换绑定的数据</a></li><li><a href="https://learn.microsoft.com/zh-cn/dotnet/api/system.windows.data.relativesourcemode?view=windowsdesktop-8.0" target=_blank rel="noopener noreferrer">RelativeSourceMode Enum</a></li></ul></article><section class="article labels"><a class=category href=/categories/c%23/>C#</a><a class=tag href=/tags/wpf/>WPF</a><a class=tag href=/tags/c%23/>C#</a><a class=tag href=/tags/itemscontrol/>ItemsControl</a><a class=tag href=/tags/itemcontainergenerator/>ItemContainerGenerator</a></section><section class="article author"><p class=name>学少何</p><div class=bio><em>不求上进的社畜……</em></div><div class=details><a class=item href=https://github.com/studylessshape target=_blank rel="noopener noreferrer"><span class="iconfont icon-github"></span>&nbsp;studylessshape</a></div></section></div><div class="article bottom"></div></section><section id=footer><div style=display:flex;flex-direction:column;flex-wrap:wrap;justify-content:center;align-content:center;align-items:center><p style=flex-shrink:0>© 2024 学少何</p><p><span>Powered by </span><a href=https://gohugo.io target=_blank>Hugo</a><span> and the </span><a href=https://github.com/cntrump/hugo-notepadium target=_blank>Notepadium</a></p></div></section><script src=/js/hljs.min.6f979583f61e4ec5f0b94f94eab2e130ee628032474d374414dba4e33cc12097a0d01fe65b33378b23f6d3b053b95445.js integrity=sha384-b5eVg/YeTsXwuU+U6rLhMO5igDJHTTdEFNuk4zzBIJeg0B/mWzM3iyP207BTuVRF></script><script>hljs.initHighlightingOnLoad()</script></body></html>