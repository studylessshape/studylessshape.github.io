<!doctype html><html lang=zh><meta charset=utf-8><meta name=generator content="Hugo 0.119.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><title>如何入门 Rust 的宏？&nbsp;&ndash;&nbsp;学少何Blog</title><link rel=stylesheet href=/css/core.min.32478a57f52c16ea8d985cfbd2d28edda6d39bfc82a9b118b94caa532c16ce3f1e869e1d49ccce4a74134efed6bdafa0.css integrity=sha384-MkeKV/UsFuqNmFz70tKO3abTm/yCqbEYuUyqUywWzj8ehp4dSczOSnQTTv7Wva+g><meta name=twitter:card content="summary"><meta name=twitter:title content="如何入门 Rust 的宏？"><body><section id=header><div class="header wrap"><span class="header left-side"><a class="site home" href=/><span class="site name">学少何Blog</span></a></span>
<span class="header right-side"><div class="nav wrap"><nav class=nav><a class="nav item" href=/categories>归类</a><a class="nav item" href=/tags>标签</a><a class="nav item" href=/about>关于</a><a class="nav item" href=/index%2exml>RSS</a></nav></div></span></div></section><section id=content><div class=article-container><section class="article header"><h1 class="article title">如何入门 Rust 的宏？</h1><p class="article date">2023年12月17日 12:17<span class=lastmod> • 更新于 2023年12月20日 12:20</span></p></section><article class="article markdown-body"><blockquote><p>避免长篇大论，可以直接翻到最底下的<a href=#%e6%95%b4%e7%90%86>整理</a>一栏。</p></blockquote><h2 id=rust-的宏是什么>Rust 的宏是什么？</h2><p>Rust 的宏可以看作编译时期，将代码按照编写好的宏规则去生成的指令。换句话说就是用一定的规则将原来的代码替换掉。</p><p>常见的宏有两种，一个是 <code>macro_rules!</code> 声明的<strong>声明式宏</strong>，另一种是和 Rust 函数一样的写法的<strong>过程宏</strong>。</p><h2 id=如何入门学习>如何入门/学习</h2><p>之前我也是看见宏复杂的符号和奇怪的语法，而没有想法去学习。</p><p>学习宏我觉得最重要的还是通过实例去学习，需要一定的积累才能够理解宏，首先要理解宏做了什么，然后才是实现它。</p><h3 id=入门学习必备的-crate-和工具>入门学习必备的 crate 和工具</h3><p>有几个很方便的 <code>crate</code>，在宏小册中也提到了，学习过程宏时，使用这几个 <code>crate</code> 会很方便。</p><ul><li><a href=https://docs.rs/syn target=_blank rel="noopener noreferrer">syn</a>：面向过程宏，解析语法树</li><li><a href=https://docs.rs/quote target=_blank rel="noopener noreferrer">quote</a></li></ul><p>必备的工具是 <a href=https://github.com/dtolnay/cargo-expand target=_blank rel="noopener noreferrer">cargo-expand</a>，使用下面的指令安装和使用：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cargo install cargo-expand <span class=c1># install</span>
</span></span><span class=line><span class=cl>cargo expand <span class=c1># run</span>
</span></span></code></pre></div><p><a href=https://github.com/dtolnay/cargo-expand target=_blank rel="noopener noreferrer">cargo-expand</a> 可以展开宏代码，看到代码通过宏替换后的样子，非常方便，除了可以观察自己的宏有哪些问题，还可以观察其他 <code>crate</code> 中，复杂的宏在使用时发生了什么。</p><h3 id=入门学习的教程和网站>入门学习的教程和网站</h3><p>宏到底是个什么，可以阅读一下 <a href=https://rustwiki.org/zh-CN/reference/macros.html target=_blank rel="noopener noreferrer">Rust 参考手册（中文版非官方翻译）</a>，了解声明宏和过程宏。</p><p>入门学习宏可以使用 <a href=https://github.com/dtolnay/proc-macro-workshop target=_blank rel="noopener noreferrer">proc-macro-workshop</a> 进行学习。这个仓库中包含了几个比较常用的声明宏和过程宏的实现模板。并且同时可以阅读学习 <a href=https://rustwiki.org/zh-CN/rust-by-example/macros.html target=_blank rel="noopener noreferrer">使用 macro_rules! 来创建宏（通过例子学 Rust 中文版）</a>。</p><blockquote><p><a href=https://docs.rs/syn target=_blank rel="noopener noreferrer">syn</a>、<a href=https://docs.rs/quote target=_blank rel="noopener noreferrer">quote</a> 和 <a href=https://github.com/dtolnay/proc-macro-workshop target=_blank rel="noopener noreferrer">proc-macro-workshop</a> 都是大佬 <a href=https://github.com/dtolnay target=_blank rel="noopener noreferrer">dtolnay</a> 实现的，真的太强了！</p></blockquote><p>另外，宏小册，即 <a href=https://veykril.github.io/tlborm/ target=_blank rel="noopener noreferrer">The Little Book of Rust Macros</a>，可以当作工具书进行参阅。</p><h2 id=闲话>闲话</h2><p>一个朋友之前尝试写了个类似于 <code>lisp</code> 的脚本语言的解析库，名叫 <a href=https://gitee.com/ZerAx/dj-rs target=_blank rel="noopener noreferrer">dj</a>。我就尝试为其实现一个运行器，方便测试和运行。</p><p>而最近突然萌生了写宏的想法，刚好又完成了 <a href=https://gitee.com/study_less_shape/dj-runner target=_blank rel="noopener noreferrer">dj-runner</a> 的编程。在实现的过程中发现 <a href=https://gitee.com/ZerAx/dj-rs target=_blank rel="noopener noreferrer">dj</a> 中的 <code>Value::Builtin</code>，和 <a href=https://actix.rs/ target=_blank rel="noopener noreferrer">actix-web</a> 中的路由以及 <a href=https://bevyengine.org/ target=_blank rel="noopener noreferrer">bevy</a> 中的 <code>System</code> 有着相似的形式，就想着能不能尝试将内建函数的形式简化。</p><p>后来实际的实现与路由和 <code>System</code> 差别挺大的，实现的方式也比较粗暴，但总的来说效果还不错，能够感觉到一些学习宏并实现一个的成就感。</p><h2 id=整理>整理</h2><ul><li><code>crate</code><ul><li><a href=https://docs.rs/syn target=_blank rel="noopener noreferrer">syn</a>：面向过程宏，解析语法树</li><li><a href=https://docs.rs/quote target=_blank rel="noopener noreferrer">quote</a></li></ul></li><li>教程<ul><li><a href=https://rustwiki.org/zh-CN/reference/macros.html target=_blank rel="noopener noreferrer">Rust 参考手册（中文版非官方翻译）</a></li><li><a href=https://github.com/dtolnay/proc-macro-workshop target=_blank rel="noopener noreferrer">proc-macro-workshop</a></li><li><a href=https://rustwiki.org/zh-CN/rust-by-example/macros.html target=_blank rel="noopener noreferrer">使用 macro_rules! 来创建宏（通过例子学 Rust 中文版）</a></li><li><a href=https://veykril.github.io/tlborm/ target=_blank rel="noopener noreferrer">The Little Book of Rust Macros</a></li></ul></li></ul></article><section class="article labels"><a class=category href=/categories/rust/>Rust</a><a class=tag href=/tags/rust/>Rust</a><a class=tag href=/tags/%E5%AE%8F/>宏</a></section><section class="article author"><p class=name>学少何</p><div class=bio><em>不求上进的社畜……</em></div><div class=details><a class=item href=https://github.com/studylessshape target=_blank rel="noopener noreferrer"><span class="iconfont icon-github"></span>&nbsp;studylessshape</a></div></section></div><div class="article bottom"><section class="article navigation"><p><a class=link href=/post/note/record-github-action-for-gitee-to-github/><span class="iconfont icon-article"></span>记一次使用 Github action 同步 Gitee 仓库到 Github</a></p><p><a class=link href=/post/rust/how-axum-start-with-websocket/><span class="iconfont icon-article"></span>有关 Axum 中 WebSocket 的使用</a></p></section></div></section><section id=footer><div style=display:flex;flex-direction:column;flex-wrap:wrap;justify-content:center;align-content:center;align-items:center><p style=flex-shrink:0>© 2024 学少何</p><p><span>Powered by </span><a href=https://gohugo.io target=_blank>Hugo</a><span> and the </span><a href=https://github.com/cntrump/hugo-notepadium target=_blank>Notepadium</a></p></div></section><script src=/js/hljs.min.6f979583f61e4ec5f0b94f94eab2e130ee628032474d374414dba4e33cc12097a0d01fe65b33378b23f6d3b053b95445.js integrity=sha384-b5eVg/YeTsXwuU+U6rLhMO5igDJHTTdEFNuk4zzBIJeg0B/mWzM3iyP207BTuVRF></script><script>hljs.initHighlightingOnLoad()</script></body></html>