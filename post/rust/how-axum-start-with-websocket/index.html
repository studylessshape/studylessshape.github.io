<!doctype html><html lang=zh><meta charset=utf-8><meta name=generator content="Hugo 0.119.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><title>有关 Axum 中 WebSocket 的使用&nbsp;&ndash;&nbsp;学少何Blog</title><link rel=stylesheet href=/css/core.min.32478a57f52c16ea8d985cfbd2d28edda6d39bfc82a9b118b94caa532c16ce3f1e869e1d49ccce4a74134efed6bdafa0.css integrity=sha384-MkeKV/UsFuqNmFz70tKO3abTm/yCqbEYuUyqUywWzj8ehp4dSczOSnQTTv7Wva+g><meta name=twitter:card content="summary"><meta name=twitter:title content="有关 Axum 中 WebSocket 的使用"><body><section id=header><div class="header wrap"><span class="header left-side"><a class="site home" href=/><span class="site name">学少何Blog</span></a></span>
<span class="header right-side"><div class="nav wrap"><nav class=nav><a class="nav item" href=/categories>归类</a><a class="nav item" href=/tags>标签</a><a class="nav item" href=/about>关于</a><a class="nav item" href=/index%2exml>RSS</a></nav></div></span></div></section><section id=content><div class=article-container><section class="article header"><h1 class="article title">有关 Axum 中 WebSocket 的使用</h1><p class="article date">2023年10月22日 10:22</p></section><article class="article markdown-body"><h1 id=开始>开始</h1><h2 id=创建-axum-项目>创建 <code>axum</code> 项目</h2><p>创建一个项目，并将 <code>axum</code> 添加到依赖中：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cargo new axum-ws-test
</span></span><span class=line><span class=cl><span class=nb>cd</span> axum-ws-test
</span></span><span class=line><span class=cl>cargo add tokio -F full
</span></span><span class=line><span class=cl>cargo add serde_json
</span></span><span class=line><span class=cl>cargo add axum -F ws
</span></span><span class=line><span class=cl>cargo add rand
</span></span></code></pre></div><p>然后用自己喜欢的编辑器/IDE 打开整个项目，找到 <code>Cargo.toml</code>，可以看到 <code>Cargo.toml</code> 如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>dependencies</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>axum</span> <span class=p>=</span> <span class=p>{</span> <span class=nx>version</span> <span class=p>=</span> <span class=s2>&#34;0.6.20&#34;</span><span class=p>,</span> <span class=nx>features</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;ws&#34;</span><span class=p>]</span> <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nx>rand</span> <span class=p>=</span> <span class=s2>&#34;0.8.5&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>serde_json</span> <span class=p>=</span> <span class=s2>&#34;1.0.107&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>tokio</span> <span class=p>=</span> <span class=p>{</span> <span class=nx>version</span> <span class=p>=</span> <span class=s2>&#34;1.33.0&#34;</span><span class=p>,</span> <span class=nx>features</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;full&#34;</span><span class=p>]</span> <span class=p>}</span>
</span></span></code></pre></div><blockquote><p>以上依赖版本为本文编写时的最新稳定版，需要注意和自己的版本区别，<code>axum</code> 的功能基本都有解释，可以查看 <a href=https://docs.rs/axum/latest/axum/#feature-flags target=_blank rel="noopener noreferrer"><code>axum</code> 文档</a></p></blockquote><h3 id=axum-的程序基本结构><code>axum</code> 的程序基本结构</h3><p>从官方文档可以看到，一个 <code>axum</code> 程序，包含了程序入口、路由、路由服务和 <code>axum</code> 服务端（即 <code>axum::Server</code>），我们先将其基本结构写入到 <code>main.rs</code> 的文件中（代码来自官方文档）：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>axum</span>::<span class=p>{</span><span class=n>routing</span>::<span class=n>get</span><span class=p>,</span><span class=w> </span><span class=n>Router</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 主函数入口
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=cp>#[tokio::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 路由
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>app</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Router</span>::<span class=n>new</span><span class=p>().</span><span class=n>route</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span><span class=w> </span><span class=n>get</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=s>&#34;Hello, World!&#34;</span><span class=w> </span><span class=p>}));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// axum 的 Server
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>axum</span>::<span class=n>Server</span>::<span class=n>bind</span><span class=p>(</span><span class=o>&amp;</span><span class=s>&#34;0.0.0.0:8081&#34;</span><span class=p>.</span><span class=n>parse</span><span class=p>().</span><span class=n>unwrap</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>serve</span><span class=p>(</span><span class=n>app</span><span class=p>.</span><span class=n>into_make_service</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>运行程序后，打开 <a href=localhost:8081>localhost:8081</a>，应该可以看见网页上有 <code>Hello, World!</code>。</p><h2 id=创建前端项目>创建前端项目</h2><p>前端使用 <code>Vue</code>，建议选择另一个文件夹来创建前端项目。输入下面的指令来创建前端项目，项目名称命名为 <code>axum-test-front</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>npm create vue@latest
</span></span><span class=line><span class=cl><span class=nb>cd</span> axum-test-front
</span></span><span class=line><span class=cl>npm install
</span></span><span class=line><span class=cl>npm run dev
</span></span></code></pre></div><h2 id=直接使用-http-请求>直接使用 Http 请求</h2><p>我们模拟的情况试试，前端每次点击按钮都会获取后端的一个随机数。一开始我们先不使用 WebSocket，来测试一下效果。</p><h3 id=后端代码>后端代码</h3><p>添加一个函数，用于前端获取随机数：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>axum</span>::<span class=p>{</span><span class=n>response</span>::<span class=n>Json</span><span class=p>,</span><span class=w> </span><span class=n>routing</span>::<span class=n>get</span><span class=p>,</span><span class=w> </span><span class=n>Router</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>rand</span>::<span class=n>Rng</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>serde_json</span>::<span class=p>{</span><span class=n>json</span><span class=p>,</span><span class=w> </span><span class=n>Value</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[tokio::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>app</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Router</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>route</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span><span class=w> </span><span class=n>get</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=s>&#34;Hello, World!&#34;</span><span class=w> </span><span class=p>}))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// add here
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=p>.</span><span class=n>route</span><span class=p>(</span><span class=s>&#34;/random&#34;</span><span class=p>,</span><span class=w> </span><span class=n>get</span><span class=p>(</span><span class=n>get_rand</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Server
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// handler
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>get_rand</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>Json</span><span class=o>&lt;</span><span class=n>Value</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>rng</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rand</span>::<span class=n>thread_rng</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Json</span><span class=p>(</span><span class=fm>json!</span><span class=w> </span><span class=p>({</span><span class=s>&#34;num&#34;</span>: <span class=nc>rng</span><span class=p>.</span><span class=n>gen_range</span><span class=p>(</span><span class=mi>1</span><span class=o>..=</span><span class=mi>100</span><span class=p>)}))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>可以在浏览器中输入 <a href=localhost:8081/random>localhost:8081/random</a>来测试，每个刷新应该都可以得到一个新的 <code>num</code> 值。</p><h3 id=前端代码>前端代码</h3><p>前端在 <code>App.vue</code> 中添加一个按钮和一个用于显示获取到的随机数的节点，代码如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=kr>export</span> <span class=k>default</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>num</span><span class=o>:</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=nx>methods</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>get_random</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 从后端的对应地址获取随机数
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>fetch</span><span class=p>(</span><span class=s2>&#34;http://localhost:8081/random&#34;</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>mode</span><span class=o>:</span> <span class=s2>&#34;cors&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=nx>headers</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>accpet</span><span class=o>:</span> <span class=s2>&#34;application/json&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=p>},</span>
</span></span><span class=line><span class=cl>        <span class=p>})</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>response</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>response</span><span class=p>.</span><span class=nx>json</span><span class=p>())</span>
</span></span><span class=line><span class=cl>          <span class=p>.</span><span class=nx>then</span><span class=p>((</span><span class=nx>data</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>this</span><span class=p>.</span><span class=nx>num</span> <span class=o>=</span> <span class=nx>data</span><span class=p>.</span><span class=nx>num</span><span class=p>;</span>
</span></span><span class=line><span class=cl>          <span class=p>});</span>
</span></span><span class=line><span class=cl>      <span class=p>},</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>&lt;</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;</span><span class=nt>main</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>button</span> <span class=err>@</span><span class=na>click</span><span class=o>=</span><span class=s>&#34;get_random()&#34;</span><span class=p>&gt;</span>click to get num<span class=p>&lt;/</span><span class=nt>button</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span><span class=p>&gt;</span>num is {{ num }}<span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl>  <span class=p>&lt;/</span><span class=nt>main</span><span class=p>&gt;</span>
</span></span><span class=line><span class=cl><span class=p>&lt;/</span><span class=nt>template</span><span class=p>&gt;</span>
</span></span></code></pre></div><p>执行的时候会发现无法从后端拿到数据，这是因为后端没有配置跨域请求。</p><h3 id=为后端配置跨域>为后端配置跨域</h3><p>首先需要添加一个依赖，输入下面的指令添加：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cargo add tower-http -F cors
</span></span></code></pre></div><p>然后在创建路由之前，先新建一个跨域的许可：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>axum</span>::<span class=p>{</span><span class=n>http</span>::<span class=n>HeaderValue</span><span class=p>,</span><span class=w> </span><span class=n>response</span>::<span class=n>Json</span><span class=p>,</span><span class=w> </span><span class=n>routing</span>::<span class=n>get</span><span class=p>,</span><span class=w> </span><span class=n>Router</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>rand</span>::<span class=n>Rng</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>serde_json</span>::<span class=p>{</span><span class=n>json</span><span class=p>,</span><span class=w> </span><span class=n>Value</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>tower_http</span>::<span class=n>cors</span>::<span class=p>{</span><span class=n>Any</span><span class=p>,</span><span class=w> </span><span class=n>CorsLayer</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[tokio::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 跨域配置
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>cors</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>CorsLayer</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>allow_methods</span><span class=p>(</span><span class=n>Any</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>allow_headers</span><span class=p>(</span><span class=n>Any</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>allow_origin</span><span class=p>(</span><span class=s>&#34;http://localhost:5173&#34;</span><span class=p>.</span><span class=n>parse</span>::<span class=o>&lt;</span><span class=n>HeaderValue</span><span class=o>&gt;</span><span class=p>().</span><span class=n>unwrap</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>app</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Router</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>route</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span><span class=w> </span><span class=n>get</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=s>&#34;Hello, World!&#34;</span><span class=w> </span><span class=p>}))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 为路由方法处理添加跨域许可
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=p>.</span><span class=n>route</span><span class=p>(</span><span class=s>&#34;/random&#34;</span><span class=p>,</span><span class=w> </span><span class=n>get</span><span class=p>(</span><span class=n>get_rand</span><span class=p>).</span><span class=n>layer</span><span class=p>(</span><span class=n>cors</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Server
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>这时再运行后端和前端，打开前端的网页，点击按钮应该可以每次获取到不同的数字。打开开发者控制台，并选择网络（没有的话点加号或者 <code>》</code> 可以找到），再多次点击按钮，可以看到每次点击按钮都发送了一次 Http 请求。</p><blockquote><p>如果前端开发者控制台报 <code style=color:red>Uncaught (in promise) ReferenceError: num is not defined</code> 这种错误，应该是在给 Vue 中 <code>data</code> 里的字段赋值的时候没有加 <code>this</code> 关键字，把 <code>num</code> 改为 <code>this.num</code> 即可</p></blockquote><h1 id=改为-websocket-传输随机数>改为 WebSocket 传输随机数</h1><h2 id=后端代码修改>后端代码修改</h2><p>添加一个新的函数，函数名为 <code>handle_random</code>，再添加一个函数名为 <code>handle_random_socket</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>handle_random</span><span class=p>(</span><span class=n>ws_upgrade</span>: <span class=nc>WebSocketUpgrade</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>Response</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ws_upgrade</span><span class=p>.</span><span class=n>on_upgrade</span><span class=p>(</span><span class=n>handle_random_socket</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>handle_random_socket</span><span class=p>(</span><span class=k>mut</span><span class=w> </span><span class=n>socket</span>: <span class=nc>WebSocket</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>socket</span><span class=p>.</span><span class=n>recv</span><span class=p>().</span><span class=k>await</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Ok</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>msg</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Web Socket Closed&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>在 <code>handle_random</code> 中，调用 <code>ws_upgrade</code> 的 <code>on_upgrade</code> 函数可以建立 Web Socket 连接。<code>handle_random_socket</code> 就是用于处理连接时的函数，此处先使用循环来接收来自连接另一端的消息，如果接收发生错误或者无法接收到，则视为连接关闭。<code>WebSocket::recv()</code> 函数在连接关闭后，才会返回 <code>None</code>。</p><p>设想建立连接后，前端发送一个 <code>get</code> 字符串，后端收到这个字符串，如果收到的确实是 <code>get</code>，则返回给前端一个随机数。那么要做的事情就很简单了，首先要匹配发送过来的消息是否是字符串且内容是否为 <code>get</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>handle_random_socket</span><span class=p>(</span><span class=k>mut</span><span class=w> </span><span class=n>socket</span>: <span class=nc>WebSocket</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>socket</span><span class=p>.</span><span class=n>recv</span><span class=p>().</span><span class=k>await</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Ok</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=p>{</span><span class=o>..</span><span class=p>.};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 匹配字符串
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=n>Message</span>::<span class=n>Text</span><span class=p>(</span><span class=n>text</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=n>text</span><span class=p>.</span><span class=n>eq</span><span class=p>(</span><span class=s>&#34;get&#34;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=fm>todo!</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>在匹配成功后，将生成一个随机数，并返回给前端。这里会用到 <code>WebSocket</code> 的 <code>Send</code> 函数来返回响应，获取随机数可以用到之前写的函数。前端对数据的宽容性较大，所以可以考虑直接返回 JSON 格式的文本：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>handle_random_socket</span><span class=p>(</span><span class=k>mut</span><span class=w> </span><span class=n>socket</span>: <span class=nc>WebSocket</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>socket</span><span class=p>.</span><span class=n>recv</span><span class=p>().</span><span class=k>await</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Ok</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=p>{</span><span class=o>..</span><span class=p>.};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=n>Message</span>::<span class=n>Text</span><span class=p>(</span><span class=n>text</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=n>text</span><span class=p>.</span><span class=n>eq</span><span class=p>(</span><span class=s>&#34;get&#34;</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=n>socket</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 返回随机数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                    </span><span class=p>.</span><span class=n>send</span><span class=p>(</span><span class=n>Message</span>::<span class=n>Text</span><span class=p>(</span><span class=n>get_rand</span><span class=p>().</span><span class=k>await</span><span class=p>.</span><span class=n>to_string</span><span class=p>()))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=n>is_err</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// 如果出错了就关闭连接
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Web Socket Closed&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;Web Socket Closed&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>编写完成，最后将 <code>handle_random</code> 添加到路由中。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[tokio::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 跨域配置
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// 路由
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>app</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Router</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>route</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span><span class=w> </span><span class=n>get</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=s>&#34;Hello, World!&#34;</span><span class=w> </span><span class=p>}))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>route</span><span class=p>(</span><span class=s>&#34;/random&#34;</span><span class=p>,</span><span class=w> </span><span class=n>get</span><span class=p>(</span><span class=n>get_rand</span><span class=p>).</span><span class=n>layer</span><span class=p>(</span><span class=n>cors</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>route</span><span class=p>(</span><span class=s>&#34;/ws/random&#34;</span><span class=p>,</span><span class=w> </span><span class=n>get</span><span class=p>(</span><span class=n>handle_random</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// axum 的 Server
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=前端代码修改>前端代码修改</h2><p>在组件挂载时，会尝试创建一个 <code>WebSocket</code> 的连接，并且绑定一个函数，用于在收到消息后，设置 <code>num</code> 的值：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=o>&lt;</span><span class=nx>script</span><span class=o>&gt;</span>
</span></span><span class=line><span class=cl><span class=kr>export</span> <span class=k>default</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>data</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>num</span><span class=o>:</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=nx>ws</span><span class=o>:</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>methods</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>build_connect</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 防止子域的 this 与 vue 的 this 冲突
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=kd>var</span> <span class=nx>that</span> <span class=o>=</span> <span class=k>this</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>that</span><span class=p>.</span><span class=nx>ws</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WebSocket</span><span class=p>(</span><span class=s2>&#34;ws://localhost:8081/ws/random&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=c1>// 收到消息后，设置 num 的值
</span></span></span><span class=line><span class=cl><span class=c1></span>      <span class=nx>that</span><span class=p>.</span><span class=nx>ws</span><span class=p>.</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s2>&#34;message&#34;</span><span class=p>,</span> <span class=kd>function</span> <span class=p>(</span><span class=nx>event</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>that</span><span class=p>.</span><span class=nx>num</span> <span class=o>=</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>parse</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>data</span><span class=p>).</span><span class=nx>num</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl>  <span class=nx>mounted</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>this</span><span class=p>.</span><span class=nx>build_connect</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=nb>window</span><span class=p>.</span><span class=nx>onclose</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>this</span><span class=p>.</span><span class=nx>ws</span><span class=p>.</span><span class=nx>close</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>之后的每次点击都会变为通过连接来向后端发送消息。按照逻辑修改后的代码如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-js data-lang=js><span class=line><span class=cl><span class=nx>get_random</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 通过连接向后端发送信息
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>this</span><span class=p>.</span><span class=nx>ws</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=s2>&#34;get&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>},</span>
</span></span></code></pre></div><h2 id=运行>运行</h2><p>首先启动后端：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>cargo run
</span></span></code></pre></div><p>然后启动前端：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>npm run dev
</span></span></code></pre></div><p>打开前端页面，点击按钮就可以看到每次都能够从后端获取到不同的随机数的效果了。</p><h1 id=参考>参考</h1><ol><li><a href=https://docs.rs/axum target=_blank rel="noopener noreferrer">axum</a><ul><li><a href=https://docs.rs/axum/latest/axum/extract/ws/index.html target=_blank rel="noopener noreferrer">axum::extract::ws - Rust</a></li></ul></li><li><a href=https://cn.vuejs.org/ target=_blank rel="noopener noreferrer">vue</a></li><li><a href=https://developer.mozilla.org/zh-CN/docs/Web/API/WebSocket target=_blank rel="noopener noreferrer">WebSocket - Web API 接口参考 | MDN</a></li></ol></article><section class="article labels"><a class=category href=/categories/rust/>Rust</a><a class=tag href=/tags/rust/>Rust</a><a class=tag href=/tags/axum/>axum</a><a class=tag href=/tags/websocket/>WebSocket</a><a class=tag href=/tags/vue/>vue</a></section><section class="article author"><p class=name>学少何</p><div class=bio><em>不求上进的社畜……</em></div><div class=details><a class=item href=https://github.com/studylessshape target=_blank rel="noopener noreferrer"><span class="iconfont icon-github"></span>&nbsp;studylessshape</a></div></section></div><div class="article bottom"><section class="article navigation"><p><a class=link href=/post/rust/how-to-learn-rust-macro/><span class="iconfont icon-article"></span>如何入门 Rust 的宏？</a></p><p><a class=link href=/post/rust/actix-web-with-vue/><span class="iconfont icon-article"></span>使用 Actix Web 和 Vue 在开发中遇到的问题</a></p></section></div></section><section id=footer><div style=display:flex;flex-direction:column;flex-wrap:wrap;justify-content:center;align-content:center;align-items:center><p style=flex-shrink:0>© 2024 学少何</p><p><span>Powered by </span><a href=https://gohugo.io target=_blank>Hugo</a><span> and the </span><a href=https://github.com/cntrump/hugo-notepadium target=_blank>Notepadium</a></p></div></section><script src=/js/hljs.min.6f979583f61e4ec5f0b94f94eab2e130ee628032474d374414dba4e33cc12097a0d01fe65b33378b23f6d3b053b95445.js integrity=sha384-b5eVg/YeTsXwuU+U6rLhMO5igDJHTTdEFNuk4zzBIJeg0B/mWzM3iyP207BTuVRF></script><script>hljs.initHighlightingOnLoad()</script></body></html>