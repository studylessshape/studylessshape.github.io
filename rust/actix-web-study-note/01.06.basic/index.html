<!doctype html><html lang=zh><meta charset=utf-8><meta name=generator content="Hugo 0.147.7"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><meta name=description content="actix-web 基础综合篇"><title>1.6 综合篇&nbsp;&ndash;&nbsp;学少何Blog</title><link rel=stylesheet href=/css/core.min.32478a57f52c16ea8d985cfbd2d28edda6d39bfc82a9b118b94caa532c16ce3f1e869e1d49ccce4a74134efed6bdafa0.css integrity=sha384-MkeKV/UsFuqNmFz70tKO3abTm/yCqbEYuUyqUywWzj8ehp4dSczOSnQTTv7Wva+g><meta name=twitter:card content="summary"><meta name=twitter:title content="1.6 综合篇"><body><section id=header><div class="header wrap"><span class="header left-side"><a class="site home" href=/><span class="site name">学少何Blog</span></a></span>
<span class="header right-side"><div class="nav wrap"><nav class=nav><a class="nav item" href=/categories>归类</a><a class="nav item" href=/tags>标签</a><a class="nav item" href=/about>关于</a><a class="nav item" href=/index%2exml>RSS</a></nav></div></span></div></section><section id=content><div class=article-container><section class="article header"><h1 class="article title">1.6 综合篇</h1><p class="article date">2022年11月1日 11:01<span class=lastmod> • 更新于 2023年10月29日 10:29</span></p></section><article class="article markdown-body"><h2 id=开始>开始</h2><p>在工作空间的 Cargo.toml 里添加 <code>"ch01/basics"</code>，添加之后内容如下所示：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>workspace</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>members</span> <span class=p>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ch01/helloworld&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ch01/error-handling&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ch01/state&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ch01/nested-routing&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ch01/static-files&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ch01/basics&#34;</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></div><p>然后在文件夹 ch01 下创建 <code>basics</code> 项目，并和之前一样添加好依赖、编写好 main.rs 的内容。</p><p>(项目的 Cargo.toml)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>dependencies</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>actix-web</span> <span class=p>=</span> <span class=s2>&#34;4.2.1&#34;</span>
</span></span></code></pre></div><p>(main.rs)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>actix_web</span>::<span class=p>{</span><span class=n>HttpServer</span><span class=p>,</span><span class=w> </span><span class=n>App</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[actix_web::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HttpServer</span>::<span class=n>new</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>App</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>bind</span><span class=p>((</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>8080</span><span class=p>))</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>run</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>这一次，我们将官方源码中的 static 下的内容直接复制到项目下。有两个 Html、一张图片和一个图标文件。Html 的内容也不复杂，welcome.html 显示了一行字和一个图片，404.html 中则是一个超链接，另一个是一行文字。</p><p>在官方例子的 Readme.md 中，列出了访问路径和会出现的结果。那么这些也将是我们之后需要做的。</p><blockquote><ul><li><a href=http://localhost:8080/async-body/bob target=_blank rel="noopener noreferrer">http://localhost:8080/async-body/bob</a></li><li><a href=http://localhost:8080/user/bob target=_blank rel="noopener noreferrer">http://localhost:8080/user/bob/</a> text/plain download</li><li><a href=http://localhost:8080/test target=_blank rel="noopener noreferrer">http://localhost:8080/test</a> (return status switch GET or POST or other)</li><li><a href=http://localhost:8080/favicon target=_blank rel="noopener noreferrer">http://localhost:8080/favicon</a></li><li><a href=http://localhost:8080/static/welcome.html target=_blank rel="noopener noreferrer">http://localhost:8080/welcome</a></li><li><a href=http://localhost:8080/static/404.html target=_blank rel="noopener noreferrer">http://localhost:8080/notexit</a> display 404 page</li><li><a href=http://localhost:8080/error target=_blank rel="noopener noreferrer">http://localhost:8080/error</a> Panic after request</li></ul></blockquote><h2 id=添加中间件>添加中间件</h2><p>中间件先从最熟悉的 <code>Logger</code> 开始添加。</p><p>在 Cargo.toml 中添加对 <code>env_logger</code> 和 <code>log</code> 的依赖：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=nx>env_logger</span> <span class=p>=</span> <span class=s2>&#34;0.9&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>log</span> <span class=p>=</span> <span class=s2>&#34;0.4&#34;</span>
</span></span></code></pre></div><p>然后在主函数 <code>HttpServer</code> 初始化前，初始化好 <code>env_logger</code>，并使用 <code>log::info!()</code> 打印一段消息，表示程序启动。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[actix_web::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>env_logger</span>::<span class=n>init_from_env</span><span class=p>(</span><span class=n>env_logger</span>::<span class=n>Env</span>::<span class=n>new</span><span class=p>().</span><span class=n>default_filter_or</span><span class=p>(</span><span class=s>&#34;info&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span>::<span class=fm>info!</span><span class=p>(</span><span class=s>&#34;starting HTTP server at http://localhost:8080&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HttpServer</span>::<span class=n>new</span><span class=p>(</span><span class=o>..</span><span class=p>.)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>bind</span><span class=p>((</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>8080</span><span class=p>))</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>run</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>之后在 <code>App</code> 中，添加 <code>Logger</code> 中间件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>actix_web</span>::<span class=p>{</span><span class=n>HttpServer</span><span class=p>,</span><span class=w> </span><span class=n>App</span><span class=p>,</span><span class=w> </span><span class=n>middleware</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[actix_web::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>env_logger</span>::<span class=n>init_from_env</span><span class=p>(</span><span class=n>env_logger</span>::<span class=n>Env</span>::<span class=n>new</span><span class=p>().</span><span class=n>default_filter_or</span><span class=p>(</span><span class=s>&#34;info&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>log</span>::<span class=fm>info!</span><span class=p>(</span><span class=s>&#34;starting HTTP server at http://localhost:8080&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HttpServer</span>::<span class=n>new</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>App</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// add here
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=p>.</span><span class=n>wrap</span><span class=p>(</span><span class=n>middleware</span>::<span class=n>Logger</span>::<span class=n>default</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>bind</span><span class=p>((</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>8080</span><span class=p>))</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>run</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>接下来添加 <code>Compress</code> 中间件，暂时不清楚用处。值得注意的是 <code>Compress</code> 中间件需要优先注册，所以将其放在 <code>Logger</code> 前：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[actix_web::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// log...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>HttpServer</span>::<span class=n>new</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>App</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// add here
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=p>.</span><span class=n>wrap</span><span class=p>(</span><span class=n>middleware</span>::<span class=n>Compress</span>::<span class=n>default</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>wrap</span><span class=p>(</span><span class=n>middleware</span>::<span class=n>Logger</span>::<span class=n>default</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>bind</span><span class=p>((</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>8080</span><span class=p>))</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>run</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>之后添加 <code>SessionMiddleware</code> 中间件，但是需要提前添加引用：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=nx>actix-session</span> <span class=p>=</span> <span class=p>{</span> <span class=nx>version</span> <span class=p>=</span> <span class=s2>&#34;0.7&#34;</span><span class=p>,</span> <span class=nx>features</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;cookie-session&#34;</span><span class=p>]</span> <span class=p>}</span>
</span></span></code></pre></div><p>查看<a href=https://docs.rs/actix-session/0.7.2/actix_session/struct.SessionMiddleware.html target=_blank rel="noopener noreferrer">文档</a>，注意到两条比较重要的信息，即 <code>SessionMiddleware</code> 主要的工作：</p><blockquote><ul><li>根据 Session 的状态和已经执行的操作，来指示 Session 存储后端为该 Session 附加上创建/更新/删除/检索状态。（按我的理解，就是可以对 Session 执行四种操作）</li><li>在客户端，设置/删除 Cookie，确保用户在发送不同的 Http 请求时， 始终关联同一个 Session。</li></ul></blockquote><p><code>SessionMiddleware</code> 的添加比其他两个中间件复杂一点。首先需要创建一个数组 <code>SESSION_SIGNING_KEY</code>，并通过这个数组生成一个 <code>key</code>，然后在 <code>SessionMiddleware</code> 构建的时候传入。官方源码中，还设置了 <code>cookie_sercue</code>，大致是用来确保 http 也能够传输：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>actix_session</span>::<span class=p>{</span><span class=n>SessionMiddleware</span><span class=p>,</span><span class=w> </span><span class=n>storage</span>::<span class=n>CookieSessionStore</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>actix_web</span>::<span class=p>{</span><span class=n>HttpServer</span><span class=p>,</span><span class=w> </span><span class=n>App</span><span class=p>,</span><span class=w> </span><span class=n>middleware</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>static</span><span class=w> </span><span class=no>SESSION_SIGNING_KEY</span>: <span class=kp>&amp;</span><span class=p>[</span><span class=kt>u8</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=p>[</span><span class=mi>0</span><span class=p>;</span><span class=w> </span><span class=mi>64</span><span class=p>];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[actix_web::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// log...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>actix_web</span>::<span class=n>cookie</span>::<span class=n>Key</span>::<span class=n>from</span><span class=p>(</span><span class=no>SESSION_SIGNING_KEY</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HttpServer</span>::<span class=n>new</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>App</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>wrap</span><span class=p>(</span><span class=n>middleware</span>::<span class=n>Compress</span>::<span class=n>default</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// add here
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=p>.</span><span class=n>wrap</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>SessionMiddleware</span>::<span class=n>builder</span><span class=p>(</span><span class=n>CookieSessionStore</span>::<span class=n>default</span><span class=p>(),</span><span class=w> </span><span class=n>key</span><span class=p>.</span><span class=n>clone</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=n>cookie_secure</span><span class=p>(</span><span class=kc>false</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=n>build</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>wrap</span><span class=p>(</span><span class=n>middleware</span>::<span class=n>Logger</span>::<span class=n>default</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>bind</span><span class=p>((</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>8080</span><span class=p>))</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>run</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=路由配置>路由配置</h2><p>一共是 9 个路由，按官方源码来一个一个配置。（注意不是之前 Readme.md 中的顺序）</p><h3 id=favicon-路由配置><code>favicon</code> 路由配置</h3><p><code>favicon</code> 函数对应的路径是 <code>"/favicon"</code>，只做一件事，就是返回 favicon.ico 文件。在此之前需要先添加对 <code>actix-file</code> 的依赖：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=nx>actix-files</span> <span class=p>=</span> <span class=s2>&#34;0.6&#34;</span>
</span></span></code></pre></div><p>添加 <code>favicon</code> 函数，直接使用 <code>actix_web::get</code> 宏配置路径。注意到这时使用的 <code>Result</code> 为 <code>actix_web::Result</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>actix_files</span>::<span class=n>NamedFile</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>actix_session</span>::<span class=p>{</span><span class=n>SessionMiddleware</span><span class=p>,</span><span class=w> </span><span class=n>storage</span>::<span class=n>CookieSessionStore</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>actix_web</span>::<span class=p>{</span><span class=n>HttpServer</span><span class=p>,</span><span class=w> </span><span class=n>App</span><span class=p>,</span><span class=w> </span><span class=n>middleware</span><span class=p>,</span><span class=w> </span><span class=n>Responder</span><span class=p>,</span><span class=w> </span><span class=n>get</span><span class=p>,</span><span class=w> </span><span class=nb>Result</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[get(</span><span class=s>&#34;/favicon&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>favicon</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=k>impl</span><span class=w> </span><span class=n>Responder</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>NamedFile</span>::<span class=n>open</span><span class=p>(</span><span class=s>&#34;static/favicon.ico&#34;</span><span class=p>)</span><span class=o>?</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>在主函数中，通过 <code>service</code> 函数，将 <code>favicon</code> 路由添加到 <code>App</code> 中：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[actix_web::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ....
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HttpServer</span>::<span class=n>new</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>App</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// middle ware register
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1>// add favicon here
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=n>favicon</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>bind</span><span class=p>((</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>8080</span><span class=p>))</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>run</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>可以尝试运行并访问 <a href=http://localhost:8080/favicon target=_blank rel="noopener noreferrer">http://localhost:8080/favicon</a>，没出错应该能够看到齿轮图标。</p></blockquote><h3 id=welcome-路由><code>welcome</code> 路由</h3><p><code>welcome</code> 路由的路径也是直接通过 <code>actix_web::get</code> 宏来配置，指定的路径为 <code>"/welcome"</code>；<code>welcome</code> 函数传入的参数类型为 <code>HttpRequest</code> 和 <code>Session</code>，两种类型都实现了 <code>FromRequest</code> trait。官方源码中，首先打印了这一次请求的内容：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>actix_session</span>::<span class=p>{</span><span class=n>SessionMiddleware</span><span class=p>,</span><span class=w> </span><span class=n>storage</span>::<span class=n>CookieSessionStore</span><span class=p>,</span><span class=w> </span><span class=n>Session</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>actix_web</span>::<span class=p>{</span><span class=n>HttpServer</span><span class=p>,</span><span class=w> </span><span class=n>App</span><span class=p>,</span><span class=w> </span><span class=n>middleware</span><span class=p>,</span><span class=w> </span><span class=n>Responder</span><span class=p>,</span><span class=w> </span><span class=n>get</span><span class=p>,</span><span class=w> </span><span class=n>HttpRequest</span><span class=p>,</span><span class=w> </span><span class=n>HttpResponse</span><span class=p>,</span><span class=w> </span><span class=nb>Result</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[get(</span><span class=s>&#34;/welcome&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>welcome</span><span class=p>(</span><span class=n>req</span>: <span class=nc>HttpRequest</span><span class=p>,</span><span class=w> </span><span class=n>session</span>: <span class=nc>Session</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>HttpResponse</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>print!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{req:?}</span><span class=s>&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>todo!</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>然后，为 <code>session</code> 添加了一个计数器，在每次访问 <code>"/welcome"</code> 加一。设置计数器的值的方式是，先新建一个 <code>counter</code> 整型可变变量，初始值为 1，然后获取 <code>session</code> 中的 <code>counter</code>，并提取到 <code>count</code> 变量中。如果存在则将 <code>counter</code> 的值设置为 <code>count</code> 加一，否则则会将 <code>counter</code> 的初始值设置给 <code>session</code> 中的<code>counter</code>。这样的话，在第一次访问时，因为 <code>session</code> 中没有 <code>counter</code>，所以在第一次访问之后，<code>session</code> 中新增了 <code>counter</code>，并且值为 1。在之后访问时，就可以获取到 <code>counter</code> 的值。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[get(</span><span class=s>&#34;/welcome&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>welcome</span><span class=p>(</span><span class=n>req</span>: <span class=nc>HttpRequest</span><span class=p>,</span><span class=w> </span><span class=n>session</span>: <span class=nc>Session</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>HttpResponse</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>print!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{req:?}</span><span class=s>&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// set counter for session
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>counter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>count</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>session</span><span class=p>.</span><span class=n>get</span>::<span class=o>&lt;</span><span class=kt>i32</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&#34;counter&#34;</span><span class=p>)</span><span class=o>?</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>counter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>session</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=s>&#34;counter&#34;</span><span class=p>,</span><span class=w> </span><span class=n>counter</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>todo!</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>接下来是写好返回值。返回的状态码为 200，内容类型为 plaintext，内容直接为 <code>welcome.html</code> 中的所有内容。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>actix_web</span>::<span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HttpServer</span><span class=p>,</span><span class=w> </span><span class=n>App</span><span class=p>,</span><span class=w> </span><span class=n>middleware</span><span class=p>,</span><span class=w> </span><span class=n>Responder</span><span class=p>,</span><span class=w> </span><span class=n>get</span><span class=p>,</span><span class=w> </span><span class=n>HttpRequest</span><span class=p>,</span><span class=w> </span><span class=n>HttpResponse</span><span class=p>,</span><span class=w> </span><span class=nb>Result</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>http</span>::<span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>StatusCode</span><span class=p>,</span><span class=w> </span><span class=n>header</span>::<span class=n>ContentType</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[get(</span><span class=s>&#34;/welcome&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>welcome</span><span class=p>(</span><span class=n>req</span>: <span class=nc>HttpRequest</span><span class=p>,</span><span class=w> </span><span class=n>session</span>: <span class=nc>Session</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>HttpResponse</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>print!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{req:?}</span><span class=s>&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// set counter for session
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>counter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>count</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>session</span><span class=p>.</span><span class=n>get</span>::<span class=o>&lt;</span><span class=kt>i32</span><span class=o>&gt;</span><span class=p>(</span><span class=s>&#34;counter&#34;</span><span class=p>)</span><span class=o>?</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>counter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>session</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=s>&#34;counter&#34;</span><span class=p>,</span><span class=w> </span><span class=n>counter</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>HttpResponse</span>::<span class=n>build</span><span class=p>(</span><span class=n>StatusCode</span>::<span class=no>OK</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>content_type</span><span class=p>(</span><span class=n>ContentType</span>::<span class=n>plaintext</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>body</span><span class=p>(</span><span class=fm>include_str!</span><span class=p>(</span><span class=s>&#34;../static/welcome.html&#34;</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>最后将 <code>welcome</code> 添加到 <code>App</code> 中。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[actix_web::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>HttpServer</span>::<span class=n>new</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>App</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// middle ware register
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=n>favicon</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// add here
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=n>welcome</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>bind</span><span class=p>((</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>8080</span><span class=p>))</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>run</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>可以尝试运行并访问 <a href=http://localhost:8080/welcome target=_blank rel="noopener noreferrer">http://localhost:8080/welcome</a>。没出错应该会看到 welcome.html 的源码。可以尝试将 <code>.content_type(ContentType::plaintext())</code> 改为 <code>.content_type(ContentType::html())</code>，不过图片会无法访问，所以无法显示。</p></blockquote><h3 id=路径-username-的路由>路径 <code>"/user/{name}"</code> 的路由</h3><p>路径对应的路由为 <code>with_param</code>，表示访问时带有参数。应该是匹配 <code>{name}</code> 的内容，使用提取器来获取。提取器的位置在函数的传入参数中，这里使用到了 <code>Path</code> 提取器。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>actix_web</span>::<span class=n>web</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>with_param</span><span class=p>(</span><span class=n>req</span>: <span class=nc>HttpRequest</span><span class=p>,</span><span class=w> </span><span class=n>path</span>: <span class=nc>web</span>::<span class=n>Path</span><span class=o>&lt;</span><span class=nb>String</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>HttpResponse</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>print!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{req:?}</span><span class=s>&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>todo!</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>返回的状态码为 200，内容类型为 plaintext，返回的内容为一串字符串，不过字符串中会出现路径中 <code>{name}</code> 处的字符串。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>with_param</span><span class=p>(</span><span class=n>req</span>: <span class=nc>HttpRequest</span><span class=p>,</span><span class=w> </span><span class=n>path</span>: <span class=nc>web</span>::<span class=n>Path</span><span class=o>&lt;</span><span class=nb>String</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>HttpResponse</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>print!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{req:?}</span><span class=s>&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HttpResponse</span>::<span class=nb>Ok</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>content_type</span><span class=p>(</span><span class=n>ContentType</span>::<span class=n>plaintext</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>body</span><span class=p>(</span><span class=fm>format!</span><span class=p>(</span><span class=s>&#34;Hello </span><span class=si>{}</span><span class=s>!&#34;</span><span class=p>,</span><span class=w> </span><span class=n>path</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>最后在 <code>App</code> 的 <code>service</code> 配置路径和路由：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[actix_web::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ....
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>HttpServer</span>::<span class=n>new</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>App</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// middel ware
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=n>favicon</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=n>welcome</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// add here
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=n>web</span>::<span class=n>resource</span><span class=p>(</span><span class=s>&#34;/user/{name}&#34;</span><span class=p>).</span><span class=n>route</span><span class=p>(</span><span class=n>web</span>::<span class=n>get</span><span class=p>().</span><span class=n>to</span><span class=p>(</span><span class=n>with_param</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>bind</span><span class=p>((</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>8080</span><span class=p>))</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>run</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>如果访问 <a href=http://localhost:8080/user/bob target=_blank rel="noopener noreferrer">http://localhost:8080/user/bob</a>，可以看到网页上显示的字符串为 <code>Hello bob!</code>，当然如果 <code>bob</code> 换成其他字符串也能够显示。</p><p>在传入的参数中，我没有像官方一样使用 <code>web::Path&lt;(String,)></code>，指定元组，而是直接指定了 <code>String</code>。当然也是能够运行的。另外，也可以在函数上直接使用 <code>#[get("/user/{name}")]</code> 配置路由的路径，这样一来，<code>App</code> 这边应该改为 <code>App.service(with_param)</code>。</p><h3 id=路径-async-bodyname-的路由>路径 <code>"/async-body/{name}"</code> 的路由</h3><p>路径 <code>"/async-body/{name}"</code> 对应的路由函数为 <code>response_body</code>。传入的参数为路径提取器，提取类型为 <code>String</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>response_body</span><span class=p>(</span><span class=n>path</span>: <span class=nc>web</span>::<span class=n>Path</span><span class=o>&lt;</span><span class=nb>String</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>HttpResponse</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>todo!</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>之后从提取器中获取提取的值，在返回 Http 响应时，返回了响应流。响应流通过 <code>stream!</code> 创建了迭代器，模拟实现异步操作。返回的内容为 <code>Hello {name}!</code>，分单词符号异步传输。</p><p>首先需要添加 <code>async-stream</code> 依赖。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=nx>async-stream</span> <span class=p>=</span> <span class=s2>&#34;0.3&#34;</span>
</span></span></code></pre></div><p>然后编写 <code>response_body</code> 函数：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=n>convert</span>::<span class=n>Infallible</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>async_stream</span>::<span class=n>stream</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>response_body</span><span class=p>(</span><span class=n>path</span>: <span class=nc>web</span>::<span class=n>Path</span><span class=o>&lt;</span><span class=nb>String</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>HttpResponse</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>path</span><span class=p>.</span><span class=n>into_inner</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HttpResponse</span>::<span class=nb>Ok</span><span class=p>().</span><span class=n>streaming</span><span class=p>(</span><span class=fm>stream!</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kr>yield</span><span class=w> </span><span class=nb>Ok</span>::<span class=o>&lt;</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>Infallible</span><span class=o>&gt;</span><span class=p>(</span><span class=n>web</span>::<span class=n>Bytes</span>::<span class=n>from</span><span class=p>(</span><span class=s>&#34;Hello &#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kr>yield</span><span class=w> </span><span class=nb>Ok</span>::<span class=o>&lt;</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>Infallible</span><span class=o>&gt;</span><span class=p>(</span><span class=n>web</span>::<span class=n>Bytes</span>::<span class=n>from</span><span class=p>(</span><span class=n>name</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kr>yield</span><span class=w> </span><span class=nb>Ok</span>::<span class=o>&lt;</span><span class=n>_</span><span class=p>,</span><span class=w> </span><span class=n>Infallible</span><span class=o>&gt;</span><span class=p>(</span><span class=n>web</span>::<span class=n>Bytes</span>::<span class=n>from</span><span class=p>(</span><span class=s>&#34;!&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><code>yield Ok::&lt;T,E></code> 中，<code>_</code> 代表自动识别类型，后面传入的是 <code>web::Bytes</code>，所以这里也是这个类型。而 <code>E</code> 指定的类型为 <code>Infallible</code>，查看文档，发现这个类型代表着 <code>Result</code> 不会返回错误。</p><p>编写好后，将 <code>response_body</code> 添加到 <code>App</code> 里。当然，路径可以通过 <code>#[get()]</code> 宏直接配置，也可以通过 <code>web::resource().to()</code> 或 <code>web::resource().route(web::get().to())</code> 配置。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[actix_web::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ....
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>HttpServer</span>::<span class=n>new</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>App</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// middle ware
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=n>favicon</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=n>welcome</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=n>with_param</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// add here
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=n>web</span>::<span class=n>resource</span><span class=p>(</span><span class=s>&#34;/async-body/{name}&#34;</span><span class=p>).</span><span class=n>route</span><span class=p>(</span><span class=n>web</span>::<span class=n>get</span><span class=p>().</span><span class=n>to</span><span class=p>(</span><span class=n>response_body</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>bind</span><span class=p>((</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>8080</span><span class=p>))</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>run</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>运行并访问 <a href=http://localhost:8080/async-body/bob target=_blank rel="noopener noreferrer">http://localhost:8080/async-body/bob</a>，应该会出现 <code>Hello bob!</code>。</p><h3 id=路径-test-的路由>路径 <code>/test</code> 的路由</h3><p><code>/test</code> 的路由采用了匿名函数的形式，直接在配置时添加。在访问这个路径时，如果请求的方法为 <code>GET</code>，则会返回 200；如果为 <code>POST</code>，则会返回 405；其他的请求方法，则会返回 404。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>actix_web</span>::<span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HttpServer</span><span class=p>,</span><span class=w> </span><span class=n>App</span><span class=p>,</span><span class=w> </span><span class=n>middleware</span><span class=p>,</span><span class=w> </span><span class=n>Responder</span><span class=p>,</span><span class=w> </span><span class=n>get</span><span class=p>,</span><span class=w> </span><span class=n>HttpRequest</span><span class=p>,</span><span class=w> </span><span class=n>HttpResponse</span><span class=p>,</span><span class=w> </span><span class=nb>Result</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>http</span>::<span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>StatusCode</span><span class=p>,</span><span class=w> </span><span class=n>header</span>::<span class=n>ContentType</span><span class=p>,</span><span class=w> </span><span class=n>Method</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=n>web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[actix_web::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ....
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>HttpServer</span>::<span class=n>new</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>App</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// middle ware
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1>// other path and route
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1>// path &#34;/test&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>web</span>::<span class=n>resource</span><span class=p>(</span><span class=s>&#34;/test&#34;</span><span class=p>).</span><span class=n>to</span><span class=p>(</span><span class=o>|</span><span class=n>req</span>: <span class=nc>HttpRequest</span><span class=o>|</span><span class=w> </span><span class=k>match</span><span class=w> </span><span class=o>*</span><span class=n>req</span><span class=p>.</span><span class=n>method</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Method</span>::<span class=no>GET</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>HttpResponse</span>::<span class=nb>Ok</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Method</span>::<span class=no>POST</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>HttpResponse</span>::<span class=n>MethodNotAllowed</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>HttpResponse</span>::<span class=n>NotFound</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>bind</span><span class=p>((</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>8080</span><span class=p>))</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>run</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>可以使用一些工具来对 <a href=http://localhost:8080/test target=_blank rel="noopener noreferrer">http://localhost:8080/test</a> 进行测试。</p><h3 id=路径-error-的路由>路径 <code>/error</code> 的路由</h3><p>和 <code>/test</code> 的路由一样是直接使用匿名函数来配置。函数内就构建了一个 <code>InternalError</code> 并返回。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=p>{</span><span class=n>convert</span>::<span class=n>Infallible</span><span class=p>,</span><span class=w> </span><span class=n>io</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[actix_web::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ....
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>HttpServer</span>::<span class=n>new</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>App</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// other configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1>// path &#34;/error&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>web</span>::<span class=n>resource</span><span class=p>(</span><span class=s>&#34;/error&#34;</span><span class=p>).</span><span class=n>to</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>actix_web</span>::<span class=n>error</span>::<span class=n>InternalError</span>::<span class=n>new</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>io</span>::<span class=n>Error</span>::<span class=n>new</span><span class=p>(</span><span class=n>io</span>::<span class=n>ErrorKind</span>::<span class=n>Other</span><span class=p>,</span><span class=w> </span><span class=s>&#34;test&#34;</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>StatusCode</span>::<span class=no>INTERNAL_SERVER_ERROR</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>bind</span><span class=p>((</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>8080</span><span class=p>))</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>run</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>编写完代码后，运行并访问 <a href=http://localhost:8080/error target=_blank rel="noopener noreferrer">http://localhost:8080/error</a>，可以看到 <code>test</code>，和返回值中创建并传入的 <code>io::Error</code> 中的字符串一致。而控制台中，会得到一行状态码为 500 的输出。</p><h3 id=路径-static-的路由>路径 <code>/static</code> 的路由</h3><p>在访问路径 <code>/static</code> 时，会直接以文件形式显示目录 static 下的所有内容。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>actix_files</span>::<span class=p>{</span><span class=n>NamedFile</span><span class=p>,</span><span class=w> </span><span class=n>Files</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[actix_web::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ....
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>HttpServer</span>::<span class=n>new</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>App</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// other configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1>// path &#34;/static&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=n>Files</span>::<span class=n>new</span><span class=p>(</span><span class=s>&#34;/static&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;static&#34;</span><span class=p>).</span><span class=n>show_files_listing</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>bind</span><span class=p>((</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>8080</span><span class=p>))</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>run</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>运行并访问 <a href=http://localhost:8080/static target=_blank rel="noopener noreferrer">http://localhost:8080/static</a>，应该可以看到 <code>static</code> 目录下的所有文件，这些文件都是可以访问的。</p><h3 id=根路径的路由>根路径的路由</h3><p>在访问根路径时，会重定向到 static/welcome.html。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>actix_web</span>::<span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HttpServer</span><span class=p>,</span><span class=w> </span><span class=n>App</span><span class=p>,</span><span class=w> </span><span class=n>middleware</span><span class=p>,</span><span class=w> </span><span class=n>Responder</span><span class=p>,</span><span class=w> </span><span class=n>get</span><span class=p>,</span><span class=w> </span><span class=n>HttpRequest</span><span class=p>,</span><span class=w> </span><span class=n>HttpResponse</span><span class=p>,</span><span class=w> </span><span class=nb>Result</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>http</span>::<span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>StatusCode</span><span class=p>,</span><span class=w> </span><span class=n>header</span>::<span class=p>{</span><span class=n>ContentType</span><span class=p>,</span><span class=w> </span><span class=bp>self</span><span class=p>},</span><span class=w> </span><span class=n>Method</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=n>web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[actix_web::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>HttpServer</span>::<span class=n>new</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>App</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// other configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=c1>// path &#34;/&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>web</span>::<span class=n>resource</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>).</span><span class=n>route</span><span class=p>(</span><span class=n>web</span>::<span class=n>get</span><span class=p>().</span><span class=n>to</span><span class=p>(</span><span class=o>|</span><span class=n>req</span>: <span class=nc>HttpRequest</span><span class=o>|</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=k>move</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{req:?}</span><span class=s>&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>HttpResponse</span>::<span class=n>Found</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=n>insert_header</span><span class=p>((</span><span class=n>header</span>::<span class=no>LOCATION</span><span class=p>,</span><span class=w> </span><span class=s>&#34;static/welcome.html&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>.</span><span class=n>finish</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>bind</span><span class=p>((</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>8080</span><span class=p>))</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>run</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>在 <code>insert_header</code> 中，传入的 <code>header::LOCATION</code> 代表重定向。如果运行并访问 <a href=http://localhost:8080/ target=_blank rel="noopener noreferrer">http://localhost:8080/</a>，会发现链接变成了 <a href=http://localhost:8080/static/welcome.html target=_blank rel="noopener noreferrer">http://localhost:8080/static/welcome.html</a>，并且显示了 welcome.html 的网页内容。</p><h3 id=默认路由配置>默认路由配置</h3><p>默认路由是在访问其他路径时，如果没有对应路由，则会运行默认路由。</p><p>默认路由对应的函数为 <code>default_handler</code>。函数内，逻辑大概是，如果请求方法为 <code>GET</code>，则返回 404.html 网页；否则返回 405 状态码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>actix_web</span>::<span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HttpServer</span><span class=p>,</span><span class=w> </span><span class=n>App</span><span class=p>,</span><span class=w> </span><span class=n>middleware</span><span class=p>,</span><span class=w> </span><span class=n>Responder</span><span class=p>,</span><span class=w> </span><span class=n>get</span><span class=p>,</span><span class=w> </span><span class=n>HttpRequest</span><span class=p>,</span><span class=w> </span><span class=n>HttpResponse</span><span class=p>,</span><span class=w> </span><span class=nb>Result</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>http</span>::<span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>StatusCode</span><span class=p>,</span><span class=w> </span><span class=n>header</span>::<span class=p>{</span><span class=n>ContentType</span><span class=p>,</span><span class=w> </span><span class=bp>self</span><span class=p>},</span><span class=w> </span><span class=n>Method</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>},</span><span class=w> </span><span class=n>web</span><span class=p>,</span><span class=w> </span><span class=n>Either</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>default_handler</span><span class=p>(</span><span class=n>req_method</span>: <span class=nc>Method</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=k>impl</span><span class=w> </span><span class=n>Responder</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>match</span><span class=w> </span><span class=n>req_method</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Method</span>::<span class=no>GET</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>file</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>NamedFile</span>::<span class=n>open</span><span class=p>(</span><span class=s>&#34;static/404.html&#34;</span><span class=p>)</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=n>customize</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=n>with_status</span><span class=p>(</span><span class=n>StatusCode</span>::<span class=no>NOT_FOUND</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nb>Ok</span><span class=p>(</span><span class=n>Either</span>::<span class=n>Left</span><span class=p>(</span><span class=n>file</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=nb>Ok</span><span class=p>(</span><span class=n>Either</span>::<span class=n>Right</span><span class=p>(</span><span class=n>HttpResponse</span>::<span class=n>MethodNotAllowed</span><span class=p>().</span><span class=n>finish</span><span class=p>()))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><code>Either</code> 的作用大概是将两种不同的类型塞到同一个类型中。</p><p>编写好后访问没有配置过路由的路径，会显示 404 的网页。</p><h2 id=总结>总结</h2><p>列一下这次出现的一些东西：</p><ol><li><p>路由配置</p><ul><li>直接使用宏配置，如 <code>#[get()]</code></li><li><code>App::new().service(web::resouce().to())</code>，即调用 <code>App</code> 的 <code>service</code> 函数配置，路径使用 <code>web::resouce</code>配置，路由通过链式调用 <code>.to()</code>配置。</li><li><code>App::new().service(web::resouce().route(web::{method}().to()))</code>，<code>{method}</code> 带指请求方法。</li><li>静态文件路由，<code>Files::new("{网站路径}", {文件路径})</code>，单个文件调用 <code>index_file</code>，要显示列表调用 <code>show_files_listing</code>。</li><li>在路由中返回静态文件，<code>NamedFile::open</code>。</li></ul></li><li><p>Session的使用：</p><blockquote><p><strong>Cookie 的创建</strong>：首先创建/生成/读取一个 64 比特的字符串，即 <code>&[u8]</code> 数组，长度为 64。然后通过 <code>actix_web::cookie::Key::from</code> 创建 <code>Key</code>。之后在 <code>App</code> 中添加中间件 <code>SessionMiddleware</code> 时，通过 <code>SessionMiddleware::builder</code> 传入 <code>Key</code>。</p><p><strong>Cookie 的使用</strong>：使用时，在路由函数的传入参数中，指定一个类型为 <code>Session</code> 的变量，通过调用这个变量的 <code>get::&lt;T></code> 来获取 cookie，也可以通过 <code>insert</code> 插入一个 key/value 对。</p></blockquote></li></ol></article><section class="article labels"><a class=category href=/categories/actix-web%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/>actix-web学习笔记</a><a class=tag href=/tags/rust/>Rust</a><a class=tag href=/tags/actix-web/>actix-web</a><a class=tag href=/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/>学习笔记</a></section><section class="article author"><p class=name>学少何</p><div class=bio><em>不求上进的社畜……</em></div><div class=details><a class=item href=https://github.com/studylessshape target=_blank rel="noopener noreferrer"><span class="iconfont icon-github"></span>&nbsp;studylessshape</a></div></section></div><div class="article bottom"><section class="article navigation"><p><a class=link href=/rust/actix-web-study-note/01.05static-files/><span class="iconfont icon-article"></span>1.5 静态文件</a></p></section></div></section><section id=footer><div style=display:flex;flex-direction:column;flex-wrap:wrap;justify-content:center;align-content:center;align-items:center><p style=flex-shrink:0>© 2024 学少何</p><p><span>Powered by </span><a href=https://gohugo.io target=_blank>Hugo</a><span> and the </span><a href=https://github.com/cntrump/hugo-notepadium target=_blank>Notepadium</a></p></div></section><script src=/js/hljs.min.68c549b01f2c96722917d73ba8d112d8d9bb5f891629166b777f3ff2810da2a2c9bde56eea10013cc86b58b4da4fe858.js integrity=sha384-aMVJsB8slnIpF9c7qNES2Nm7X4kWKRZrd38/8oENoqLJveVu6hABPMhrWLTaT+hY></script><script>hljs.initHighlightingOnLoad()</script></body></html>