<!doctype html><html lang=zh><meta charset=utf-8><meta name=generator content="Hugo 0.147.7"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><meta name=description content="actix-web 中简单的异常处理"><title>1.2 异常处理&nbsp;&ndash;&nbsp;学少何Blog</title><link rel=stylesheet href=/css/core.min.32478a57f52c16ea8d985cfbd2d28edda6d39bfc82a9b118b94caa532c16ce3f1e869e1d49ccce4a74134efed6bdafa0.css integrity=sha384-MkeKV/UsFuqNmFz70tKO3abTm/yCqbEYuUyqUywWzj8ehp4dSczOSnQTTv7Wva+g><meta name=twitter:card content="summary"><meta name=twitter:title content="1.2 异常处理"><body><section id=header><div class="header wrap"><span class="header left-side"><a class="site home" href=/><span class="site name">学少何Blog</span></a></span>
<span class="header right-side"><div class="nav wrap"><nav class=nav><a class="nav item" href=/categories>归类</a><a class="nav item" href=/tags>标签</a><a class="nav item" href=/about>关于</a><a class="nav item" href=/index%2exml>RSS</a></nav></div></span></div></section><section id=content><div class=article-container><section class="article header"><h1 class="article title">1.2 异常处理</h1><p class="article date">2022年10月9日 10:09<span class=lastmod> • 更新于 2022年10月14日 10:14</span></p></section><article class="article markdown-body"><h2 id=开始>开始</h2><p>首先不急着直接做各种其他的东西，而是将基础的东西弄好。</p><p>在 workspace 的 Cargo.toml 里添加 <code>"ch01/error-handling"</code>，添加好后，文件的内容应该如下所示：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>workspace</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>members</span> <span class=p>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ch01/helloworld&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ch01/error-handling&#34;</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></div><p>进入 ch01 文件夹，创建项目，名称为 <code>error-handling</code>。在项目的 Cargo.toml 里添加 <code>actix-web</code> 依赖，如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>dependencies</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>actix-web</span> <span class=p>=</span> <span class=s2>&#34;4.2.1&#34;</span>
</span></span></code></pre></div><blockquote><p>如果需要将自己的工作空间的所有代码上传到代码管理平台，需要将创建项目同时创建的 .git 文件夹删除。注意是项目的 .git 文件夹。</p></blockquote><p>再在 main.rs 中，添加主函数，以及基础的内容：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>actix_web</span>::<span class=p>{</span><span class=n>HttpServer</span><span class=p>,</span><span class=w> </span><span class=n>App</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[actix_web::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HttpServer</span>::<span class=n>new</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>App</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>bind</span><span class=p>((</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>8080</span><span class=p>))</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>run</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>上述的代码内容，之前基本都已经大致理解了一下。接下来开始异常处理的内容。</p><h2 id=显示内容>显示内容</h2><p>刚开始暂时先不做其他的事情，而是显示一个简短的内容。看一下源码，源码中为函数 <code>do_something</code> 配置了路径和路由。那么我们一开始也就先做这一部分内容。</p><p>编写 <code>do_something</code> 函数，其中要注意到返回值的类型为 <code>Result&lt;HttpResponse, Error></code>。函数中返回一个字符串，内容为“Nothing interesting happened. Try again.”，意思大致是“没有什么有意思的事情发生，请再次尝试”。编写好的函数内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>do_something</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>HttpResponse</span><span class=p>,</span><span class=w> </span><span class=n>Error</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>HttpResponse</span>::<span class=nb>Ok</span><span class=p>().</span><span class=n>body</span><span class=p>(</span><span class=s>&#34;Nothing interesting happened. Try again.&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>如果没有使用 rust-analyzer 的自动补充功能，此时顶部的引用应该已经如下所示：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>actix_web</span>::<span class=p>{</span><span class=n>HttpServer</span><span class=p>,</span><span class=w> </span><span class=n>App</span><span class=p>,</span><span class=w> </span><span class=n>HttpResponse</span><span class=p>,</span><span class=w> </span><span class=n>Error</span><span class=p>};</span><span class=w>
</span></span></span></code></pre></div><p>注意返回值中的 <code>Error</code>，是 <code>actix_web</code> 的，而不是 <code>std</code> 中的 <code>Error</code>。</p></blockquote><p>接下来，要为其配置路径。查看官方例子中，发现此时用了另一种方式配置路由，即 <code>web::resource().route()</code>。</p><p>在顶部添加 <code>web</code> 引用。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>actix_web</span>::<span class=n>web</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>然后在 <code>App::new()</code> 后面，为 <code>do_something</code> 配置路径为 <code>/something</code>。代码如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HttpServer</span>::<span class=n>new</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>App</span>::<span class=n>new</span><span class=p>().</span><span class=n>service</span><span class=p>(</span><span class=n>web</span>::<span class=n>resource</span><span class=p>(</span><span class=s>&#34;/something&#34;</span><span class=p>).</span><span class=n>route</span><span class=p>(</span><span class=n>web</span>::<span class=n>get</span><span class=p>().</span><span class=n>to</span><span class=p>(</span><span class=n>do_something</span><span class=p>)))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>bind</span><span class=p>((</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>8080</span><span class=p>))</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>run</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>运行，进入网址 <code>localhost:8080/something</code> 看看，能显示 <code>do_something</code> 中返回的内容则说明代码没有问题。</p><h2 id=添加错误>添加错误</h2><p>在源码中，自定义了一个名为 <code>CustomError</code> 的枚举类。在编写之前，先在 Cargo.toml 中添加 <code>derive_more</code>：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>dependencies</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>actix-web</span> <span class=p>=</span> <span class=s2>&#34;4.2.1&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>derive_more</span> <span class=p>=</span> <span class=s2>&#34;0.99.5&#34;</span>
</span></span></code></pre></div><p>搞定，现在添加 <code>CustomError</code>。内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>derive_more</span>::<span class=n>Display</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derive(Debug, Display)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>enum</span> <span class=nc>CustomError</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[display(fmt = </span><span class=s>&#34;Custom Error 1&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>CustomOne</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[display(fmt = </span><span class=s>&#34;Custom Error 2&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>CustomTwo</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[display(fmt = </span><span class=s>&#34;Custom Error 3&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>CustomThree</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[display(fmt = </span><span class=s>&#34;Custom Error 4&#34;</span><span class=cp>)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>CustomFour</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>出现了新东西 <code>Display</code>。找到 <code>derive_more</code> 的<a href=https://jeltef.github.io/derive_more/derive_more/display.html target=_blank rel="noopener noreferrer">文档</a>，可以看到作者对 <code>Display</code> 的所有描述。按我的理解，大致作用是为自己声明的结构体等提供了一个格式化字符串的方式。</p></blockquote><p>这个自定义的错误中，有四种错误。不一定有实际意义。接下来，继续查看源码，发现这些错误会随机展示一个出来。源码中，为 <code>rand::distributions::Standard</code> 实现了 <code>Distribution&lt;CustomError></code>，即为随机生成添加了 <code>CustomError</code> 这个类型的实现。通过这个实现可以在调用 <code>rand::random</code> 时，随机生成一个此类型的值。</p><p>在 Cargo.toml 中添加 <code>rand</code> 这个 crate 的依赖。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>dependencies</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>actix-web</span> <span class=p>=</span> <span class=s2>&#34;4.2.1&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>derive_more</span> <span class=p>=</span> <span class=s2>&#34;0.99.5&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>rand</span> <span class=p>=</span> <span class=s2>&#34;0.8&#34;</span>
</span></span></code></pre></div><p>然后在顶部添加 <code>Distribution</code> 和 <code>Standard</code> 的引用。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>rand</span>::<span class=p>{</span><span class=n>prelude</span>::<span class=n>Distribution</span><span class=p>,</span><span class=w> </span><span class=n>distributions</span>::<span class=n>Standard</span><span class=p>};</span><span class=w>
</span></span></span></code></pre></div><p>现在，为 <code>Standard</code> 实现 <code>Distribution&lt;CustomError></code>。随机生成一个在[0,4)范围内的数字，然后根据生成的数字返回不同的 <code>CustomError</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>impl</span><span class=w> </span><span class=n>Distribution</span><span class=o>&lt;</span><span class=n>CustomError</span><span class=o>&gt;</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>Standard</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>sample</span><span class=o>&lt;</span><span class=n>R</span>: <span class=nc>rand</span>::<span class=n>Rng</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=o>?</span><span class=nb>Sized</span><span class=o>&gt;</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>rng</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>R</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>CustomError</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=n>rng</span><span class=p>.</span><span class=n>gen_range</span><span class=p>(</span><span class=mi>0</span><span class=o>..</span><span class=mi>4</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mi>0</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>CustomError</span>::<span class=n>CustomOne</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mi>1</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>CustomError</span>::<span class=n>CustomTwo</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=mi>2</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>CustomError</span>::<span class=n>CustomThree</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=n>CustomError</span>::<span class=n>CustomFour</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>由于这个错误需要返回到网页上，所以需要实现 actix-web 的 <code>ResponseError</code>，来返回对应的 Http 回应。在官方例子的源码注释中有说明，返回 200 为正常回应，而返回的 Http 错误有4种：</p><ol><li>403 Forbidden（禁止访问）</li><li>401 Unauthorized（缺少凭证）</li><li>500 InternalServerError（内部服务器的错误）</li><li>400 BadRequest（错误的请求）</li></ol><blockquote><p>可以通过<a href=https://cloud.tencent.com/developer/chapter/13553 target=_blank rel="noopener noreferrer">这个手册</a>来查看所有的 Http 错误。</p></blockquote><p>自定义的四个错误，每一个枚举都对应上面4个错误中的一个。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>actix_web</span>::<span class=p>{</span><span class=n>HttpServer</span><span class=p>,</span><span class=w> </span><span class=n>App</span><span class=p>,</span><span class=w> </span><span class=n>HttpResponse</span><span class=p>,</span><span class=w> </span><span class=n>web</span><span class=p>,</span><span class=w> </span><span class=n>Error</span><span class=p>,</span><span class=w> </span><span class=n>ResponseError</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>impl</span><span class=w> </span><span class=n>ResponseError</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>CustomError</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>fn</span> <span class=nf>error_response</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>HttpResponse</span><span class=o>&lt;</span><span class=n>actix_web</span>::<span class=n>body</span>::<span class=n>BoxBody</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=bp>self</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>CustomError</span>::<span class=n>CustomOne</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;do some stuff related to CustomOne error&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>HttpResponse</span>::<span class=n>Forbidden</span><span class=p>().</span><span class=n>finish</span><span class=p>()</span><span class=c1>// 403
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>CustomError</span>::<span class=n>CustomTwo</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;do some stuff related to CustomOne error&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>HttpResponse</span>::<span class=n>Unauthorized</span><span class=p>().</span><span class=n>finish</span><span class=p>()</span><span class=c1>// 401
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>CustomError</span>::<span class=n>CustomThree</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;do some stuff related to CustomOne error&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>HttpResponse</span>::<span class=n>InternalServerError</span><span class=p>().</span><span class=n>finish</span><span class=p>()</span><span class=c1>// 500
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;do some stuff related to CustomOne error&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>HttpResponse</span>::<span class=n>BadRequest</span><span class=p>().</span><span class=n>finish</span><span class=p>()</span><span class=c1>// 400
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=随机产生错误>随机产生错误</h2><p>一般这些错误不会直接出现，所以需要随机触发一个。添加一个 <code>do_something_random</code> 的函数来随机触发一个错误。有 20% 的机率什么都不会发生。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>rand</span>::<span class=p>{</span><span class=n>prelude</span>::<span class=n>Distribution</span><span class=p>,</span><span class=w> </span><span class=n>distributions</span>::<span class=n>Standard</span><span class=p>,</span><span class=w> </span><span class=n>thread_rng</span><span class=p>,</span><span class=w> </span><span class=n>Rng</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>do_something_random</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>(),</span><span class=w> </span><span class=n>CustomError</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>rng</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>thread_rng</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>rng</span><span class=p>.</span><span class=n>gen_bool</span><span class=p>(</span><span class=mf>2.0</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=mf>10.0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Ok</span><span class=p>(())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>rand</span>::<span class=n>random</span>::<span class=o>&lt;</span><span class=n>CustomError</span><span class=o>&gt;</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>然后在 <code>do_something</code> 中调用 <code>do_something_random</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>do_something</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>HttpResponse</span><span class=p>,</span><span class=w> </span><span class=n>Error</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>do_something_random</span><span class=p>().</span><span class=k>await</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>HttpResponse</span>::<span class=nb>Ok</span><span class=p>().</span><span class=n>body</span><span class=p>(</span><span class=s>&#34;Nothing interesting happened. Try again.&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>现在来运行看看结果。多刷新几次可以看到浏览器展示不同的错误，控制台上也打印了相应的字符串。</p><h2 id=结束>结束</h2><p>官方例子的注释说道，这个例子是用来展示如何自定义一个错误类型，来处理不同的错误。不过就目前而言确实有点抽象，可以知道的是这里的 Http 错误是由我们自己去产生的，而在 <code>println</code> 位置处，应该是需要之后去处理对应错误的函数。</p><p>当自定义一个错误类型的时候，为了能够使其返回给客户端/浏览器，需要实现 <code>ResponseError</code> 这个 <code>trait</code>。<code>ResponseError</code> 中定义的函数可以在<a href=https://docs.rs/actix-web/4.2.1/actix_web/trait.ResponseError.html target=_blank rel="noopener noreferrer">文档中</a>查看。</p><p>除此之外，还出现了新的路由配置，<code>App::new().service(web::resource('').route())</code>。</p></article><section class="article labels"><a class=category href=/categories/actix-web%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/>actix-web学习笔记</a><a class=tag href=/tags/rust/>Rust</a><a class=tag href=/tags/actix-web/>actix-web</a><a class=tag href=/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/>学习笔记</a></section><section class="article author"><p class=name>学少何</p><div class=bio><em>不求上进的社畜……</em></div><div class=details><a class=item href=https://github.com/studylessshape target=_blank rel="noopener noreferrer"><span class="iconfont icon-github"></span>&nbsp;studylessshape</a></div></section></div><div class="article bottom"><section class="article navigation"><p><a class=link href=/rust/actix-web-study-note/01.03state/><span class="iconfont icon-article"></span>1.3 状态</a></p><p><a class=link href=/rust/actix-web-study-note/01.01helloworld/><span class="iconfont icon-article"></span>1.1 Hello world</a></p></section></div></section><section id=footer><div style=display:flex;flex-direction:column;flex-wrap:wrap;justify-content:center;align-content:center;align-items:center><p style=flex-shrink:0>© 2024 学少何</p><p><span>Powered by </span><a href=https://gohugo.io target=_blank>Hugo</a><span> and the </span><a href=https://github.com/cntrump/hugo-notepadium target=_blank>Notepadium</a></p></div></section><script src=/js/hljs.min.68c549b01f2c96722917d73ba8d112d8d9bb5f891629166b777f3ff2810da2a2c9bde56eea10013cc86b58b4da4fe858.js integrity=sha384-aMVJsB8slnIpF9c7qNES2Nm7X4kWKRZrd38/8oENoqLJveVu6hABPMhrWLTaT+hY></script><script>hljs.initHighlightingOnLoad()</script></body></html>