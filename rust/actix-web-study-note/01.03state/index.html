<!doctype html><html lang=zh><meta charset=utf-8><meta name=generator content="Hugo 0.147.7"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><meta name=description content="state，状态，可以在不同的路由中共享"><title>1.3 状态&nbsp;&ndash;&nbsp;学少何Blog</title><link rel=stylesheet href=/css/core.min.32478a57f52c16ea8d985cfbd2d28edda6d39bfc82a9b118b94caa532c16ce3f1e869e1d49ccce4a74134efed6bdafa0.css integrity=sha384-MkeKV/UsFuqNmFz70tKO3abTm/yCqbEYuUyqUywWzj8ehp4dSczOSnQTTv7Wva+g><meta name=twitter:card content="summary"><meta name=twitter:title content="1.3 状态"><body><section id=header><div class="header wrap"><span class="header left-side"><a class="site home" href=/><span class="site name">学少何Blog</span></a></span>
<span class="header right-side"><div class="nav wrap"><nav class=nav><a class="nav item" href=/categories>归类</a><a class="nav item" href=/tags>标签</a><a class="nav item" href=/about>关于</a><a class="nav item" href=/index%2exml>RSS</a></nav></div></span></div></section><section id=content><div class=article-container><section class="article header"><h1 class="article title">1.3 状态</h1><p class="article date">2022年10月14日 10:14</p></section><article class="article markdown-body"><h2 id=开始>开始</h2><p>和上篇一样，先在工作空间的 Cargo.toml 中添加 <code>"ch01/state"</code>，添加之后文件内容如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>workspace</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>members</span> <span class=p>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ch01/helloworld&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ch01/error-handling&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ch01/state&#34;</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></div><p>然后新建项目，将项目依赖和 main.rs 的内容编写好。</p><p>项目 Cargo.toml：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>dependencies</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>actix-web</span> <span class=p>=</span> <span class=s2>&#34;4.2.1&#34;</span>
</span></span></code></pre></div><p>main.rs：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>actix_web</span>::<span class=p>{</span><span class=n>HttpServer</span><span class=p>,</span><span class=w> </span><span class=n>App</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[actix_web::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HttpServer</span>::<span class=n>new</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>App</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>bind</span><span class=p>((</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>8080</span><span class=p>))</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>run</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=了解-state>了解 <code>State</code></h2><p>在敲代码之前，可以先到<a href=https://actix.rs/docs/application/#state target=_blank rel="noopener noreferrer">官网</a>查看这个 <code>State</code> 是什么。</p><p>官网上的描述是：</p><blockquote><p>Application state is shared with all routes and resources within the same scope. State can be accessed with the web::Data<t> extractor where T is the type of the state. State is also accessible for middleware.</p><p>在相同的<strong>域</strong>中，所有的路由和资源可以共享应用<strong>状态</strong>（Application state）。<strong>状态</strong>（State）可以通过 <code>web::Data&lt;T></code> 来访问，其中 <code>T</code> 为状态的类型。状态也能通过<a href=https://actix.rs/docs/middleware/ target=_blank rel="noopener noreferrer">中间件</a>访问。</p></blockquote><p>可以理解为在访问网站的时候，站内链接共享的一个变量或者对象。状态也拥有<a href=https://actix.rs/docs/application/#shared-mutable-state target=_blank rel="noopener noreferrer">可变状态</a>。添加状态需要在 <code>HttpServer::new()</code> 中，通过 <code>App::new().app_data()</code> 添加。</p><h2 id=添加状态>添加状态</h2><p>看向官方源码，在 <code>HttpServer::new()</code> 前，新建了两个状态，在其中又新建了一个状态，类型分别为 <code>Data&lt;Mutex&lt;usize>></code>、<code>Data&lt;AtomicUsize></code>、<code>Cell&lt;u32></code>，即线程互斥共享状态，线程安全共享整型和内部可变整型引用，初始值都为 0。在外面创建的两个状态，属于全局状态，而在内部创建的属于线程内状态。</p><p>在 main.rs 中添加代码，将新建的状态添加到应用中。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=p>{</span><span class=n>sync</span>::<span class=p>{</span><span class=n>Mutex</span><span class=p>,</span><span class=w> </span><span class=n>atomic</span>::<span class=n>AtomicUsize</span><span class=p>},</span><span class=w> </span><span class=n>cell</span>::<span class=n>Cell</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>actix_web</span>::<span class=p>{</span><span class=n>HttpServer</span><span class=p>,</span><span class=w> </span><span class=n>App</span><span class=p>,</span><span class=w> </span><span class=n>web</span>::<span class=n>Data</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[actix_web::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[allow(clippy::mutex_atomic)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>counter_mutex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Data</span>::<span class=n>new</span><span class=p>(</span><span class=n>Mutex</span>::<span class=n>new</span><span class=p>(</span><span class=mi>0</span><span class=k>usize</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>counter_atomic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Data</span>::<span class=n>new</span><span class=p>(</span><span class=n>AtomicUsize</span>::<span class=n>new</span><span class=p>(</span><span class=mi>0</span><span class=k>usize</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HttpServer</span>::<span class=n>new</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>counter_cell</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Cell</span>::<span class=n>new</span><span class=p>(</span><span class=mi>0</span><span class=k>u32</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>App</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>app_data</span><span class=p>(</span><span class=n>counter_mutex</span><span class=p>.</span><span class=n>clone</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>app_data</span><span class=p>(</span><span class=n>counter_atomic</span><span class=p>.</span><span class=n>clone</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>app_data</span><span class=p>(</span><span class=n>Data</span>::<span class=n>new</span><span class=p>(</span><span class=n>counter_cell</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>bind</span><span class=p>((</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>8080</span><span class=p>))</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>run</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>在官方源码中，在 <code>counter_mutex</code> 上面有一行属性 <code>#[allow(clippy::mutex_atomic)]</code>，是<a href=https://rustwiki.org/zh-CN/reference/attributes/diagnostics.html target=_blank rel="noopener noreferrer">诊断属性</a>，按照本人理解，将 <code>counter_mutex</code> 标记为检查其会执行的原子操作。不过具体作用还是有点模糊。</p><h2 id=添加服务资源>添加服务资源</h2><p>上述三个状态，会在每次访问网址时，自增 1。按照官方例子添加函数 <code>index</code>。函数体内只有 <code>todo!()</code>，方便观察函数而不被报错的划线干扰。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=p>{</span><span class=n>sync</span>::<span class=p>{</span><span class=n>Mutex</span><span class=p>,</span><span class=w> </span><span class=n>atomic</span>::<span class=n>AtomicUsize</span><span class=p>},</span><span class=w> </span><span class=n>cell</span>::<span class=n>Cell</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>actix_web</span>::<span class=p>{</span><span class=n>HttpServer</span><span class=p>,</span><span class=w> </span><span class=n>App</span><span class=p>,</span><span class=w> </span><span class=n>web</span>::<span class=n>Data</span><span class=p>,</span><span class=w> </span><span class=n>HttpResponse</span><span class=p>,</span><span class=w> </span><span class=n>HttpRequest</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>index</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>counter_mutex</span>: <span class=nc>Data</span><span class=o>&lt;</span><span class=n>Mutex</span><span class=o>&lt;</span><span class=kt>usize</span><span class=o>&gt;&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>counter_cell</span>: <span class=nc>Data</span><span class=o>&lt;</span><span class=n>Cell</span><span class=o>&lt;</span><span class=kt>u32</span><span class=o>&gt;&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>counter_atomic</span>: <span class=nc>Data</span><span class=o>&lt;</span><span class=n>AtomicUsize</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>req</span>: <span class=nc>HttpRequest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>HttpResponse</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>todo!</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>看向参数部分，前三个参数是我们添加到应用中的状态，第四个 <code>req</code> 的类型为 <code>HttpRequest</code>。而返回值类型为 <code>HttpResponse</code>。</p><p>之前没有详细了解过将要访问的函数体，作为句柄添加到路由时，有哪些具体内容。首先可以在官网中的<a href=https://actix.rs/docs/handlers/ target=_blank rel="noopener noreferrer">句柄章节</a>中看到，请求句柄可以接受实现了 <code>FromRequest</code> trait 的参数，而 <a href=https://docs.rs/actix-web/4.2.1/actix_web/struct.HttpRequest.html#impl-FromRequest-for-HttpRequest target=_blank rel="noopener noreferrer"><code>HttpRequest</code></a>实现了，所以可以作为请求句柄中传入的参数。同理，<code>web::Data</code> 也是实现了 <code>FromRequest</code> trait，所以能够作为请求句柄的参数。</p><p>接下来根据不同的引用类型，来将引用的整型数字加 1。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=p>{</span><span class=n>sync</span>::<span class=p>{</span><span class=n>Mutex</span><span class=p>,</span><span class=w> </span><span class=n>atomic</span>::<span class=p>{</span><span class=n>AtomicUsize</span><span class=p>,</span><span class=w> </span><span class=n>Ordering</span><span class=p>}},</span><span class=w> </span><span class=n>cell</span>::<span class=n>Cell</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>actix_web</span>::<span class=p>{</span><span class=n>HttpServer</span><span class=p>,</span><span class=w> </span><span class=n>App</span><span class=p>,</span><span class=w> </span><span class=n>web</span>::<span class=n>Data</span><span class=p>,</span><span class=w> </span><span class=n>HttpResponse</span><span class=p>,</span><span class=w> </span><span class=n>HttpRequest</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>index</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>counter_mutex</span>: <span class=nc>Data</span><span class=o>&lt;</span><span class=n>Mutex</span><span class=o>&lt;</span><span class=kt>usize</span><span class=o>&gt;&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>counter_cell</span>: <span class=nc>Data</span><span class=o>&lt;</span><span class=n>Cell</span><span class=o>&lt;</span><span class=kt>u32</span><span class=o>&gt;&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>counter_atomic</span>: <span class=nc>Data</span><span class=o>&lt;</span><span class=n>AtomicUsize</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>req</span>: <span class=nc>HttpRequest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>HttpResponse</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{req:?}</span><span class=s>&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>*</span><span class=n>counter_mutex</span><span class=p>.</span><span class=n>lock</span><span class=p>().</span><span class=n>unwrap</span><span class=p>()</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>counter_cell</span><span class=p>.</span><span class=n>set</span><span class=p>(</span><span class=n>counter_cell</span><span class=p>.</span><span class=n>get</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>counter_atomic</span><span class=p>.</span><span class=n>fetch_add</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>Ordering</span>::<span class=n>SeqCst</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=fm>todo!</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>然后将增加后的内容，作为返回的内容。使用下面的代码替换掉 <code>todo!()</code> 的地方。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>body</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>format!</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;global mutex counter: </span><span class=si>{}</span><span class=s>, local counter: </span><span class=si>{}</span><span class=s>, global atomic counter: </span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>*</span><span class=n>counter_mutex</span><span class=p>.</span><span class=n>lock</span><span class=p>().</span><span class=n>unwrap</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>counter_cell</span><span class=p>.</span><span class=n>get</span><span class=p>(),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>counter_atomic</span><span class=p>.</span><span class=n>load</span><span class=p>(</span><span class=n>Ordering</span>::<span class=n>SeqCst</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HttpResponse</span>::<span class=nb>Ok</span><span class=p>().</span><span class=n>body</span><span class=p>(</span><span class=n>body</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p><code>index</code> 函数的内容编写完成了，现在将其配置到应用中，指定到根目录。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>std</span>::<span class=p>{</span><span class=n>sync</span>::<span class=p>{</span><span class=n>Mutex</span><span class=p>,</span><span class=w> </span><span class=n>atomic</span>::<span class=p>{</span><span class=n>AtomicUsize</span><span class=p>,</span><span class=w> </span><span class=n>Ordering</span><span class=p>}},</span><span class=w> </span><span class=n>cell</span>::<span class=n>Cell</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=n>actix_web</span>::<span class=p>{</span><span class=n>HttpServer</span><span class=p>,</span><span class=w> </span><span class=n>App</span><span class=p>,</span><span class=w> </span><span class=n>web</span>::<span class=p>{</span><span class=n>Data</span><span class=p>,</span><span class=w> </span><span class=bp>self</span><span class=p>},</span><span class=w> </span><span class=n>HttpResponse</span><span class=p>,</span><span class=w> </span><span class=n>HttpRequest</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>index</span><span class=p>(</span><span class=o>..</span><span class=p>.)</span><span class=w> </span>-&gt; <span class=nc>HttpResponse</span><span class=w> </span><span class=p>{</span><span class=o>..</span><span class=p>.}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[actix_web::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[allow(clippy::mutex_atomic)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>counter_mutex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Data</span>::<span class=n>new</span><span class=p>(</span><span class=n>Mutex</span>::<span class=n>new</span><span class=p>(</span><span class=mi>0</span><span class=k>usize</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>counter_atomic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Data</span>::<span class=n>new</span><span class=p>(</span><span class=n>AtomicUsize</span>::<span class=n>new</span><span class=p>(</span><span class=mi>0</span><span class=k>usize</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HttpServer</span>::<span class=n>new</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>counter_cell</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Cell</span>::<span class=n>new</span><span class=p>(</span><span class=mi>0</span><span class=k>u32</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>App</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>app_data</span><span class=p>(</span><span class=n>counter_mutex</span><span class=p>.</span><span class=n>clone</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>app_data</span><span class=p>(</span><span class=n>counter_atomic</span><span class=p>.</span><span class=n>clone</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>app_data</span><span class=p>(</span><span class=n>Data</span>::<span class=n>new</span><span class=p>(</span><span class=n>counter_cell</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// add here
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=n>web</span>::<span class=n>resource</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>).</span><span class=n>to</span><span class=p>(</span><span class=n>index</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>bind</span><span class=p>((</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>8080</span><span class=p>))</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>run</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>尝试运行一下，看看效果。在每一次刷新后，可以看到数字增加了 1。这时回到控制台，可以看到我们在请求句柄中打印的请求内容了，发现在 <code>HttpRequest</code> 中包含了很多信息，如 Http 请求代码、请求 UA、host等。</p><h2 id=添加日志打印功能>添加日志打印功能</h2><p>终止程序，并将 <code>index</code> 函数中，打印请求内容的函数注释掉。在 Cargo.toml 中添加 <code>env_logger</code> 的依赖。版本保证与例子的一致。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>dependencies</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>actix-web</span> <span class=p>=</span> <span class=s2>&#34;4.2.1&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>env_logger</span> <span class=p>=</span> <span class=s2>&#34;0.9.0&#34;</span>
</span></span></code></pre></div><p>然后在主函数的 <code>HttpServer::new()</code> 前，初始化 <code>env_logger</code>。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[actix_web::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// add here
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>    </span><span class=n>env_logger</span>::<span class=n>init</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[allow(clippy::mutex_atomic)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>counter_mutex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Data</span>::<span class=n>new</span><span class=p>(</span><span class=n>Mutex</span>::<span class=n>new</span><span class=p>(</span><span class=mi>0</span><span class=k>usize</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>counter_atomic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Data</span>::<span class=n>new</span><span class=p>(</span><span class=n>AtomicUsize</span>::<span class=n>new</span><span class=p>(</span><span class=mi>0</span><span class=k>usize</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HttpServer</span>::<span class=n>new</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=o>..</span><span class=p>.})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>bind</span><span class=p>((</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>8080</span><span class=p>))</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>run</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>接下来添加 <code>actix-web</code> 自带的 <code>Logger</code> 中间件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[actix_web::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>env_logger</span>::<span class=n>init</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[allow(clippy::mutex_atomic)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>counter_mutex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Data</span>::<span class=n>new</span><span class=p>(</span><span class=n>Mutex</span>::<span class=n>new</span><span class=p>(</span><span class=mi>0</span><span class=k>usize</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>counter_atomic</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Data</span>::<span class=n>new</span><span class=p>(</span><span class=n>AtomicUsize</span>::<span class=n>new</span><span class=p>(</span><span class=mi>0</span><span class=k>usize</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HttpServer</span>::<span class=n>new</span><span class=p>(</span><span class=k>move</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>counter_cell</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Cell</span>::<span class=n>new</span><span class=p>(</span><span class=mi>0</span><span class=k>u32</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>App</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>app_data</span><span class=p>(</span><span class=n>counter_mutex</span><span class=p>.</span><span class=n>clone</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>app_data</span><span class=p>(</span><span class=n>counter_atomic</span><span class=p>.</span><span class=n>clone</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>app_data</span><span class=p>(</span><span class=n>Data</span>::<span class=n>new</span><span class=p>(</span><span class=n>counter_cell</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// add here
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=p>.</span><span class=n>wrap</span><span class=p>(</span><span class=n>middleware</span>::<span class=n>Logger</span>::<span class=n>default</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=n>web</span>::<span class=n>resource</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>).</span><span class=n>to</span><span class=p>(</span><span class=n>index</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>bind</span><span class=p>((</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>8080</span><span class=p>))</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>run</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>中间件的作用很多，<code>actix-web</code> 中也提供了一些中间件，可以在<a href=https://actix.rs/docs/middleware/ target=_blank rel="noopener noreferrer">官网上</a>或者<a href=https://docs.rs/actix-web/4.2.1/actix_web/middleware/index.html target=_blank rel="noopener noreferrer">文档中</a>查看。此处添加的 <code>Logger</code> 中间件，可以将请求和回应的简洁描述打印到控制台上。要启用 <code>Logger</code>，需要提前初始化 <code>env_logger</code> 或者相似的 crate。</p><p>但是如果直接这样运行，会发现控制台上什么也不会打印。查看官方例子的代码，发现在初始化 <code>env_logger</code> 前，设置了一个临时环境变量 <code>RUST_LOG</code>，内容为 <code>actix_web=info</code>。那么我们同样的在 <code>env_logger</code> 前添加代码 <code>std::env::set_var("RUST_LOG", "actix_web=info");</code>。这时再次运行，发现访问网址时，控制台打印出日志了。</p><blockquote><p>在后面的例子代码中，也可以通过 <code>env_logger::init_from_env(env_logger::Env::new().default_filter_or("info"));</code> 来初始化，就不需要使用 <code>std::env::set_var</code> 了。</p></blockquote><h2 id=结束>结束</h2><p>这一次，了解到了可以在应用域中访问的状态。通过 <code>App::new().app_data()</code>添加状态，而且在请求句柄中添加对应的参数，就可以访问了。</p><p>要能成为请求句柄的参数，参数对应的类型需要实现 <code>FromRequest</code> trait。</p><p>除此之外，还初次了解了 <code>Logger</code> 中间件。</p></article><section class="article labels"><a class=category href=/categories/actix-web%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/>actix-web学习笔记</a><a class=tag href=/tags/rust/>Rust</a><a class=tag href=/tags/actix-web/>actix-web</a><a class=tag href=/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/>学习笔记</a></section><section class="article author"><p class=name>学少何</p><div class=bio><em>不求上进的社畜……</em></div><div class=details><a class=item href=https://github.com/studylessshape target=_blank rel="noopener noreferrer"><span class="iconfont icon-github"></span>&nbsp;studylessshape</a></div></section></div><div class="article bottom"><section class="article navigation"><p><a class=link href=/rust/actix-web-study-note/01.04nested-routing/><span class="iconfont icon-article"></span>1.4 嵌套路由</a></p><p><a class=link href=/rust/actix-web-study-note/01.02error-handling/><span class="iconfont icon-article"></span>1.2 异常处理</a></p></section></div></section><section id=footer><div style=display:flex;flex-direction:column;flex-wrap:wrap;justify-content:center;align-content:center;align-items:center><p style=flex-shrink:0>© 2024 学少何</p><p><span>Powered by </span><a href=https://gohugo.io target=_blank>Hugo</a><span> and the </span><a href=https://github.com/cntrump/hugo-notepadium target=_blank>Notepadium</a></p></div></section><script src=/js/hljs.min.68c549b01f2c96722917d73ba8d112d8d9bb5f891629166b777f3ff2810da2a2c9bde56eea10013cc86b58b4da4fe858.js integrity=sha384-aMVJsB8slnIpF9c7qNES2Nm7X4kWKRZrd38/8oENoqLJveVu6hABPMhrWLTaT+hY></script><script>hljs.initHighlightingOnLoad()</script></body></html>