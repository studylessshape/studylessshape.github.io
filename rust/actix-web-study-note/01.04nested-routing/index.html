<!doctype html><html lang=zh><meta charset=utf-8><meta name=generator content="Hugo 0.119.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><title>1.4 嵌套路由&nbsp;&ndash;&nbsp;学少何Blog</title><link rel=stylesheet href=/css/core.min.32478a57f52c16ea8d985cfbd2d28edda6d39bfc82a9b118b94caa532c16ce3f1e869e1d49ccce4a74134efed6bdafa0.css integrity=sha384-MkeKV/UsFuqNmFz70tKO3abTm/yCqbEYuUyqUywWzj8ehp4dSczOSnQTTv7Wva+g><meta name=twitter:card content="summary"><meta name=twitter:title content="1.4 嵌套路由"><body><section id=header><div class="header wrap"><span class="header left-side"><a class="site home" href=/><span class="site name">学少何Blog</span></a></span>
<span class="header right-side"><div class="nav wrap"><nav class=nav><a class="nav item" href=/categories>归类</a><a class="nav item" href=/tags>标签</a><a class="nav item" href=/about>关于</a><a class="nav item" href=/index%2exml>RSS</a></nav></div></span></div></section><section id=content><div class=article-container><section class="article header"><h1 class="article title">1.4 嵌套路由</h1><p class="article date">2022年10月17日 10:17<span class=lastmod> • 更新于 2022年10月20日 10:20</span></p></section><article class="article markdown-body"><h2 id=准备项目>准备项目</h2><p>在工作空间的 Cargo.toml 中添加行 <code>ch01/nested-routing</code>。添加后，内容如下所示：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>workspace</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>members</span> <span class=p>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ch01/helloworld&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ch01/error-handling&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ch01/state&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;ch01/nested-routing&#34;</span>
</span></span><span class=line><span class=cl><span class=p>]</span>
</span></span></code></pre></div><p>创建对应的项目之后，按照之前的方式编辑好好项目的 Cargo.toml 和 main.rs 文件内容。</p><h2 id=添加日志中间件>添加日志中间件</h2><p>这次的嵌套路由，代码会比较复杂，所以先从简单的入手。那么最容易的首先是添加 <code>Logger</code> 中间件。</p><p>在 Cargo.toml 中，添加对 <code>env_logger</code> 的依赖：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=p>[</span><span class=nx>dependencies</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nx>actix-web</span> <span class=p>=</span> <span class=s2>&#34;4.2.1&#34;</span>
</span></span><span class=line><span class=cl><span class=nx>env_logger</span> <span class=p>=</span> <span class=s2>&#34;0.9&#34;</span>
</span></span></code></pre></div><p>然后在主函数中初始化 <code>env_logger</code>，同时添加 <code>Logger</code> 中间件。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>actix_web</span>::<span class=p>{</span><span class=n>HttpServer</span><span class=p>,</span><span class=w> </span><span class=n>App</span><span class=p>,</span><span class=w> </span><span class=n>middleware</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[actix_web::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>std</span>::<span class=n>env</span>::<span class=n>set_var</span><span class=p>(</span><span class=s>&#34;RUST_LOG&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;actix_server=info,actix_web=info&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>env_logger</span>::<span class=n>init</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HttpServer</span>::<span class=n>new</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>App</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>wrap</span><span class=p>(</span><span class=n>middleware</span>::<span class=n>Logger</span>::<span class=n>default</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>bind</span><span class=p>((</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>8080</span><span class=p>))</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>run</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><blockquote><p>如果此时尝试运行项目，可以看到控制台上打印出来的日志比之前多了。而多出来的日志的标记为 <code>actix_server</code>，由此可以猜测在 <code>std::env::set_var()</code> 的 value 中填入的 <code>actix_server=info</code> 项，表示将 <code>actix_server</code> 模块的日志打印出来。除了 <code>actix_server</code> 和 <code>actix_web</code> 外，暂时不太清楚还有什么模块的日志可以设置并将日志打印出来。</p></blockquote><p>看向官方源码的项目结构，可以复刻一下其项目结构。在 src 下创建子目录 bin，并将 main.rs 移动到 bin 目录下。</p><h2 id=添加样例结构体>添加样例结构体</h2><p>在 src 目录下创建两个文件，分别为 lib.rs 和 common.rs。</p><p>lib.rs 中的内容为，将 common 模块添加到项目中。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>mod</span> <span class=nn>common</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>看向官方源码，由于需要给之后新建的结构体标记序列化，所以需要在 Cargo.toml 中添加 <code>serde</code> 的依赖。同时，还添加了 <code>serde</code> 的 <code>derive</code> 功能。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-toml data-lang=toml><span class=line><span class=cl><span class=nx>serde</span> <span class=p>=</span> <span class=p>{</span> <span class=nx>version</span> <span class=p>=</span> <span class=s2>&#34;^1.0&#34;</span><span class=p>,</span> <span class=nx>features</span> <span class=p>=</span> <span class=p>[</span><span class=s2>&#34;derive&#34;</span><span class=p>]</span> <span class=p>}</span>
</span></span></code></pre></div><blockquote><p>这里的版本号前多了一个 <code>^</code> 字符，我也是很困惑。在 rust 的 <a href=https://doc.rust-lang.org/stable/cargo/reference/resolver.html target=_blank rel="noopener noreferrer">The Cargo Book</a>中有说明，看大致意思应该是和 <code>1.0</code> 差不多。</p></blockquote><p>官方源码中，在 common.rs 里声明了两个结构体，分别是 <code>Product</code> 和 <code>Part</code>。结构体中的内容除了字段名没什么区别。并且都使用 <code>serde</code> 中的宏，标记两个结构体都是可序列化和反序列化的。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>serde</span>::<span class=p>{</span><span class=n>Deserialize</span><span class=p>,</span><span class=w> </span><span class=n>Serialize</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derive(Deserialize, Serialize)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>Product</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=kt>i64</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>product_type</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=nb>String</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>name</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=nb>String</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[derive(Deserialize, Serialize)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>Part</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=kt>i64</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>part_type</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=nb>String</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>name</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=nb>String</span><span class=o>&gt;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=添加配置函数>添加配置函数</h2><p>回到主函数，看到在 <code>App::new()</code> 之后，执行了 <code>config</code> 函数。<code>config</code> 函数的传入参数为，参数为 <code>&amp;mut ServiceConfig</code> 的函数句柄。那么按照源码的方式，在 src 下创建文件 app_config.rs，并把 <code>app_config</code> 模块添加到项目中。</p><p>(lib.rs)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>mod</span> <span class=nn>common</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>mod</span> <span class=nn>app_config</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>在 app_config.rs 中添加如下代码（其他的操作由于没有实现，所以暂时只添加路径）。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>actix_web</span>::<span class=n>web</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>config_app</span><span class=p>(</span><span class=n>cfg</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>web</span>::<span class=n>ServiceConfig</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>cfg</span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>web</span>::<span class=n>scope</span><span class=p>(</span><span class=s>&#34;/products&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=n>web</span>::<span class=n>resource</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>web</span>::<span class=n>scope</span><span class=p>(</span><span class=s>&#34;/{product_id}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=n>web</span>::<span class=n>resource</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>web</span>::<span class=n>scope</span><span class=p>(</span><span class=s>&#34;/parts&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=n>web</span>::<span class=n>resource</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=n>web</span>::<span class=n>resource</span><span class=p>(</span><span class=s>&#34;/{part_id}&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>简单的分析一下。在上面的代码中，首先以 <code>/products</code> 路径创建了一个域。这个域是什么呢？通过<a href=https://actix.rs/docs/url-dispatch/index.html#scoping-routes target=_blank rel="noopener noreferrer">官方主页</a>的教程中的描述看，域是用来更好的组织路由的，并且可以让域内的路由共享一个根目录。同时可以通过域，来实现嵌套路由。</p><p>根据我个人的理解，相当于将 <code>/xx/yy/zz</code> 拆解成 <code>xx</code> 域，<code>xx</code> 域下的 <code>yy</code> 域，<code>yy</code> 域下的 <code>zz</code> 域。可以让路径的配置更加清晰，通过分层级的域，来更好的控制路由的路径。</p><p>那么配置嵌套路由的时候，<code>/{part_id}</code> 和 <code>/{products_id}</code> 这两个路径是什么呢？这是匹配路径或者说可变路径，在程序中可以通过调用特定函数来获取到匹配路径的值。具体可以看向<a href=https://actix.rs/docs/url-dispatch/index.html#match-information target=_blank rel="noopener noreferrer">官方的说明</a>。</p><p>上面的代码编写好后，配置的嵌套路径结构大致如下所示。</p><p><img src=./nested-path-struct.png alt></p><p>然后回到 main.rs，将编写好的配置函数添加到 <code>App</code> 的配置中：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>actix_web</span>::<span class=p>{</span><span class=n>HttpServer</span><span class=p>,</span><span class=w> </span><span class=n>App</span><span class=p>,</span><span class=w> </span><span class=n>middleware</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// add use mod
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>use</span><span class=w> </span><span class=n>nested_routing</span>::<span class=n>app_config</span>::<span class=n>config_app</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cp>#[actix_web::main]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>io</span>::<span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>std</span>::<span class=n>env</span>::<span class=n>set_var</span><span class=p>(</span><span class=s>&#34;RUST_LOG&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;actix_server=info,actix_web=info&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>env_logger</span>::<span class=n>init</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>HttpServer</span>::<span class=n>new</span><span class=p>(</span><span class=o>||</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>App</span>::<span class=n>new</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// add function
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>            </span><span class=p>.</span><span class=n>configure</span><span class=p>(</span><span class=n>config_app</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>wrap</span><span class=p>(</span><span class=n>middleware</span>::<span class=n>Logger</span>::<span class=n>default</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>bind</span><span class=p>((</span><span class=s>&#34;127.0.0.1&#34;</span><span class=p>,</span><span class=w> </span><span class=mi>8080</span><span class=p>))</span><span class=o>?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=n>run</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.</span><span class=k>await</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=添加路由>添加路由</h2><p>在 src 下添加子目录 handlers，并创建文件 mod.rs、parts.rs和products.rs。在 mod.rs 中，将 <code>parts</code> 和 <code>products</code> 模块添加进去。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>mod</span> <span class=nn>parts</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>mod</span> <span class=nn>products</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>在 lib.rs 中，将 <code>handlers</code> 模块添加到项目中。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>mod</span> <span class=nn>common</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>mod</span> <span class=nn>app_config</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// add here
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>pub</span><span class=w> </span><span class=k>mod</span> <span class=nn>handlers</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>通过上面配置路径的时候，可以发现 <code>Products</code> 的层级比 <code>Parts</code> 高，所以先来试着编写 Products.rs 中的内容。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>actix_web</span>::<span class=p>{</span><span class=n>web</span><span class=p>,</span><span class=w> </span><span class=n>HttpResponse</span><span class=p>,</span><span class=w> </span><span class=n>Error</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=k>crate</span>::<span class=n>common</span>::<span class=p>{</span><span class=n>Part</span><span class=p>,</span><span class=w> </span><span class=n>Product</span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>get_products</span><span class=p>(</span><span class=n>_query</span>: <span class=nc>web</span>::<span class=n>Query</span><span class=o>&lt;</span><span class=nb>Option</span><span class=o>&lt;</span><span class=n>Part</span><span class=o>&gt;&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>HttpResponse</span><span class=p>,</span><span class=w> </span><span class=n>Error</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>HttpResponse</span>::<span class=nb>Ok</span><span class=p>().</span><span class=n>finish</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>add_product</span><span class=p>(</span><span class=n>_new_product</span>: <span class=nc>web</span>::<span class=n>Json</span><span class=o>&lt;</span><span class=n>Product</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>HttpResponse</span><span class=p>,</span><span class=w> </span><span class=n>Error</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>HttpResponse</span>::<span class=nb>Ok</span><span class=p>().</span><span class=n>finish</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>get_product_detail</span><span class=p>(</span><span class=n>_id</span>: <span class=nc>web</span>::<span class=n>Path</span><span class=o>&lt;</span><span class=nb>String</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>HttpResponse</span><span class=p>,</span><span class=w> </span><span class=n>Error</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>HttpResponse</span>::<span class=nb>Ok</span><span class=p>().</span><span class=n>finish</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>remove_product</span><span class=p>(</span><span class=n>_id</span>: <span class=nc>web</span>::<span class=n>Path</span><span class=o>&lt;</span><span class=nb>String</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>HttpResponse</span><span class=p>,</span><span class=w> </span><span class=n>Error</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>HttpResponse</span>::<span class=nb>Ok</span><span class=p>().</span><span class=n>finish</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>看官方源码，发现 parts.rs 里的代码和 products.rs 中的几乎一直，只是将函数名中的 <code>product</code> 换成了 <code>part</code>。目前传入这些函数的参数，并不了解其作用，但是可以发现 <code>web::Query</code>、<code>web::Json</code>、<code>web::Path</code>都是提取器。</p><p>在<a href=https://actix.rs/docs/extractors/ target=_blank rel="noopener noreferrer">官方网站</a>上对提取器有介绍。这些提取器都实现了 <code>FromRequest</code>，所以可以作为请求路由句柄的参数。</p><p>编写好 parts.rs 和 products.rs 后，回到 app_config.rs，为 <code>/products</code> 域的根目录配置了两个路由，<code>get_products</code> 对应 get 方法，<code>add_product</code> 对应 post 方法。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>use</span><span class=w> </span><span class=n>actix_web</span>::<span class=n>web</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>use</span><span class=w> </span><span class=k>crate</span>::<span class=n>handlers</span>::<span class=n>products</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>config_app</span><span class=p>(</span><span class=n>cfg</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>web</span>::<span class=n>ServiceConfig</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>cfg</span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>web</span>::<span class=n>scope</span><span class=p>(</span><span class=s>&#34;/products&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>web</span>::<span class=n>resource</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>// add here
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>                    </span><span class=p>.</span><span class=n>route</span><span class=p>(</span><span class=n>web</span>::<span class=n>get</span><span class=p>().</span><span class=n>to</span><span class=p>(</span><span class=n>products</span>::<span class=n>get_products</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=n>route</span><span class=p>(</span><span class=n>web</span>::<span class=n>post</span><span class=p>().</span><span class=n>to</span><span class=p>(</span><span class=n>products</span>::<span class=n>add_product</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=o>..</span><span class=p>.)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>然后为 <code>/products/{product_id}/</code> 添加路由，对应 get 和 delete 指令。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>config_app</span><span class=p>(</span><span class=n>cfg</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>web</span>::<span class=n>ServiceConfig</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>cfg</span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>web</span>::<span class=n>scope</span><span class=p>(</span><span class=s>&#34;/products&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=o>..</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>web</span>::<span class=n>scope</span><span class=p>(</span><span class=s>&#34;/{product_id}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>web</span>::<span class=n>resource</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>.</span><span class=n>route</span><span class=p>(</span><span class=n>web</span>::<span class=n>get</span><span class=p>().</span><span class=n>to</span><span class=p>(</span><span class=n>products</span>::<span class=n>get_product_detail</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>.</span><span class=n>route</span><span class=p>(</span><span class=n>web</span>::<span class=n>delete</span><span class=p>().</span><span class=n>to</span><span class=p>(</span><span class=n>products</span>::<span class=n>remove_product</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=o>..</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>对于 <code>/products/{product_id}/parts/</code>，添加的路由对应指令为 get 和 post。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>config_app</span><span class=p>(</span><span class=n>cfg</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>web</span>::<span class=n>ServiceConfig</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>cfg</span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>web</span>::<span class=n>scope</span><span class=p>(</span><span class=s>&#34;/products&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=o>..</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>web</span>::<span class=n>scope</span><span class=p>(</span><span class=s>&#34;/{product_id}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=o>..</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>web</span>::<span class=n>scope</span><span class=p>(</span><span class=s>&#34;/parts&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>web</span>::<span class=n>resource</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=p>.</span><span class=n>route</span><span class=p>(</span><span class=n>web</span>::<span class=n>get</span><span class=p>().</span><span class=n>to</span><span class=p>(</span><span class=n>parts</span>::<span class=n>get_parts</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=p>.</span><span class=n>route</span><span class=p>(</span><span class=n>web</span>::<span class=n>post</span><span class=p>().</span><span class=n>to</span><span class=p>(</span><span class=n>parts</span>::<span class=n>add_part</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=n>web</span>::<span class=n>resource</span><span class=p>(</span><span class=s>&#34;/{part_id}&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>对于 <code>/products/{product_id}/parts/{part_id}</code>，添加的路由对应指令为 get 和 delete。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>config_app</span><span class=p>(</span><span class=n>cfg</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>web</span>::<span class=n>ServiceConfig</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>cfg</span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>web</span>::<span class=n>scope</span><span class=p>(</span><span class=s>&#34;/products&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=o>..</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>web</span>::<span class=n>scope</span><span class=p>(</span><span class=s>&#34;/{product_id}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=o>..</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>web</span>::<span class=n>scope</span><span class=p>(</span><span class=s>&#34;/parts&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=o>..</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>.</span><span class=n>service</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>web</span>::<span class=n>resource</span><span class=p>(</span><span class=s>&#34;/{part_id}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=p>.</span><span class=n>route</span><span class=p>(</span><span class=n>web</span>::<span class=n>get</span><span class=p>().</span><span class=n>to</span><span class=p>(</span><span class=n>parts</span>::<span class=n>get_part_detail</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                    </span><span class=p>.</span><span class=n>route</span><span class=p>(</span><span class=n>web</span>::<span class=n>delete</span><span class=p>().</span><span class=n>to</span><span class=p>(</span><span class=n>parts</span>::<span class=n>remove_part</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>至此，路由都添加完毕了。</p><h2 id=学到的东西>学到的东西</h2><p>应用的配置，可以调用 <code>App.configure</code> 并传入对应句柄来操作。句柄对应函数的传入参数应该为 <code>&amp;mut web::ServiceConfig</code>，这样就可以将配置应用的内容放到其他地方。</p><p>通过 <code>web::scope()</code> 可以配置域，而域是可以包含域的，从而可以实现嵌套路由。如果要想让域包含域，需要给 <code>web::scope().service()</code> 传入下一个 <code>web::scope()</code>。同时 <code>web::scope().service()</code> 中也可以传入 <code>web::resource()</code> 来结束嵌套，路由则可以通过 <code>web::resource().route()</code> 配置。而且可以链式调用来为不同的 Http 指令配置路由。</p><p>另外是在编写路由的函数的时候，传入参数类型和返回值和之前有一点点区别，出现了之前没有见过的类型，即提取器。每一个提取器都有其对应的作用。同时也要注意到返回值 <code>Err&lt;T></code> 的泛型，填入的是 <code>actix_web::Error</code>，这是因为返回的错误类型需要实现 <code>ResponseError</code>。</p><blockquote><p>注意到这一次编写完代码后，没有进行运行测试。</p></blockquote><h2 id=额外补充可跳过>额外补充（可跳过）</h2><p>看向官方源码中的 products.rs 文件，发现有一个测试模块。这一次不再次照搬编写了，直接复制到自己项目的 products.rs 中。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=cp>#[cfg(test)]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>mod</span> <span class=nn>tests</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=n>actix_web</span>::<span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dev</span>::<span class=n>Service</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>http</span>::<span class=p>{</span><span class=n>header</span><span class=p>,</span><span class=w> </span><span class=n>StatusCode</span><span class=p>},</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>test</span><span class=p>,</span><span class=w> </span><span class=n>App</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>use</span><span class=w> </span><span class=k>crate</span>::<span class=n>app_config</span>::<span class=n>config_app</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cp>#[actix_web::test]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>async</span><span class=w> </span><span class=k>fn</span> <span class=nf>test_add_product</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>app</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>test</span>::<span class=n>init_service</span><span class=p>(</span><span class=n>App</span>::<span class=n>new</span><span class=p>().</span><span class=n>configure</span><span class=p>(</span><span class=n>config_app</span><span class=p>)).</span><span class=k>await</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>payload</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=sa>r</span><span class=s>#&#34;{&#34;id&#34;:12345,&#34;product_type&#34;:&#34;fancy&#34;,&#34;name&#34;:&#34;test&#34;}&#34;#</span><span class=p>.</span><span class=n>as_bytes</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>req</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>test</span>::<span class=n>TestRequest</span>::<span class=n>post</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>uri</span><span class=p>(</span><span class=s>&#34;/products&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>insert_header</span><span class=p>((</span><span class=n>header</span>::<span class=no>CONTENT_TYPE</span><span class=p>,</span><span class=w> </span><span class=s>&#34;application/json&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>set_payload</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>.</span><span class=n>to_request</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>resp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>app</span><span class=p>.</span><span class=n>call</span><span class=p>(</span><span class=n>req</span><span class=p>).</span><span class=k>await</span><span class=p>.</span><span class=n>unwrap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=fm>assert_eq!</span><span class=p>(</span><span class=n>resp</span><span class=p>.</span><span class=n>status</span><span class=p>(),</span><span class=w> </span><span class=n>StatusCode</span>::<span class=no>OK</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>测试模块首先是在函数句柄上，声明了宏 <code>#[actix_web::test]</code>，表明这个函数用于测试。actix-web 中也有提供用于测试的内容。这个 <code>test::init_service</code> 是手动初始化了应用服务。同时也是通过之前编写的配置函数，对应用进行了相应的配置。</p><p>之后通过 <code>actix_web::test</code> 模块，生成了一个 post 请求，内容格式为 json 数据，传输的内容对应着之前创建的 <code>Product</code> 结构体。然后通过 <code>app.call()</code> 将请求发送给应用，并获取回应。最后没有判断回应的内容，只是判断了一下回应的状态代码，因为之前配置路由时，返回的都是空内容但是状态码为 <code>OK</code> 的回应。</p></article><section class="article labels"><a class=category href=/categories/actix-web%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/>actix-web学习笔记</a><a class=tag href=/tags/rust/>Rust</a><a class=tag href=/tags/actix-web/>actix-web</a><a class=tag href=/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/>学习笔记</a></section><section class="article author"><p class=name>学少何</p><div class=bio><em>不求上进的社畜……</em></div><div class=details><a class=item href=https://github.com/studylessshape target=_blank rel="noopener noreferrer"><span class="iconfont icon-github"></span>&nbsp;studylessshape</a></div></section></div><div class="article bottom"><section class="article navigation"><p><a class=link href=/rust/actix-web-study-note/01.05static-files/><span class="iconfont icon-article"></span>1.5 静态文件</a></p><p><a class=link href=/rust/actix-web-study-note/01.03state/><span class="iconfont icon-article"></span>1.3 状态</a></p></section></div></section><section id=footer><div style=display:flex;flex-direction:column;flex-wrap:wrap;justify-content:center;align-content:center;align-items:center><p style=flex-shrink:0>© 2024 学少何</p><p><span>Powered by </span><a href=https://gohugo.io target=_blank>Hugo</a><span> and the </span><a href=https://github.com/cntrump/hugo-notepadium target=_blank>Notepadium</a></p></div></section><script src=/js/hljs.min.6f979583f61e4ec5f0b94f94eab2e130ee628032474d374414dba4e33cc12097a0d01fe65b33378b23f6d3b053b95445.js integrity=sha384-b5eVg/YeTsXwuU+U6rLhMO5igDJHTTdEFNuk4zzBIJeg0B/mWzM3iyP207BTuVRF></script><script>hljs.initHighlightingOnLoad()</script></body></html>